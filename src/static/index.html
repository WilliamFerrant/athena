<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Athena</title>
<style>
/* ═══════════════════════════════════════════════════════════════════════════
   CSS VARIABLES
   ═══════════════════════════════════════════════════════════════════════════ */
:root {
  --bg: #1a1a1a;
  --surface: #222;
  --surface2: #2a2a2a;
  --surface3: #333;
  --border: #3a3a3a;
  --border-glow: #4a6a8a;
  --text: #e8e6df;
  --text-bright: #ffffff;
  --muted: #8a8878;
  --accent: #7ca6c4;
  --accent2: #6893b3;
  --accent-dim: #7ca6c415;
  --accent-glow: #7ca6c440;
  --green: #50b583;
  --green-dim: #50b58320;
  --yellow: #eab308;
  --yellow-dim: #eab30820;
  --red: #ef4444;
  --red-dim: #ef444420;
  --blue: #7ca6c4;
  --blue-dim: #7ca6c420;
  --orange: #f97316;
  --orange-dim: #f9731620;
  --cyan: #5eb8c4;
  --cyan-dim: #5eb8c420;
  --purple: #8b7ec6;
  --purple-dim: #8b7ec620;
  --pink: #d97aa0;
  --font-mono: 'JetBrains Mono','Fira Code','Cascadia Code',monospace;
}

*{margin:0;padding:0;box-sizing:border-box}
html,body{height:100%;overflow:hidden}
body{font-family:'Inter','Segoe UI',-apple-system,sans-serif;background:var(--bg);color:var(--text);display:flex;flex-direction:column}
a{color:var(--accent);text-decoration:none}
a:hover{text-decoration:underline}

/* ═══ TOP BAR ═══════════════════════════════════════════════════════════════ */
.topbar{height:42px;background:var(--surface);border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;padding:0 16px;flex-shrink:0;z-index:500}
.topbar-left{display:flex;align-items:center;gap:12px}
.logo{font-size:14px;font-weight:800;letter-spacing:2.5px;color:var(--text-bright);text-transform:uppercase}
.logo-tag{font-size:9px;font-weight:700;letter-spacing:1px;background:var(--accent);color:var(--bg);padding:2px 8px;border-radius:3px;transition:all .4s cubic-bezier(.4,0,.2,1);cursor:pointer;user-select:none}
.logo-tag:hover{filter:brightness(1.15)}
.topbar-right{display:flex;align-items:center;gap:10px}
.tb-btn{background:none;border:1px solid var(--border);color:var(--muted);padding:4px 12px;border-radius:5px;cursor:pointer;font-size:11px;font-weight:600;letter-spacing:.5px;text-transform:uppercase;transition:all .2s;display:flex;align-items:center;gap:5px}
.tb-btn:hover{border-color:var(--accent);color:var(--accent);background:var(--accent-dim)}
.tb-btn.active{border-color:var(--accent);color:var(--accent);background:var(--accent-dim)}
.status-pill{display:flex;align-items:center;gap:5px;font-size:11px;color:var(--muted);padding:3px 10px;border-radius:5px;border:1px solid var(--border)}
.status-pill.ok{border-color:var(--green-dim);background:var(--green-dim)}
.status-pill.ok .sd{background:var(--green);box-shadow:0 0 6px var(--green)}
.status-pill.off .sd{background:var(--muted)}
.sd{width:6px;height:6px;border-radius:50%;transition:all .3s}
.clock{font-size:11px;color:var(--muted);font-family:var(--font-mono);font-weight:500}
.build-sha{font-size:9px;color:var(--border);font-family:var(--font-mono);opacity:.6;user-select:all;cursor:default;padding-left:4px}

/* ═══ MAIN 3-COL LAYOUT ═══════════════════════════════════════════════════ */
.layout{flex:1;display:grid;grid-template-columns:260px 1fr 340px;overflow:hidden;transition:grid-template-columns .5s cubic-bezier(.4,0,.2,1)}

/* Bridge mode: wider center, no file tree */
body.bridge-mode .layout{grid-template-columns:220px 1fr 340px}

/* ═══ LEFT SIDEBAR ════════════════════════════════════════════════════════ */
.sidebar{background:var(--surface);border-right:1px solid var(--border);display:flex;flex-direction:column;overflow:hidden}
.sb-section{border-bottom:1px solid var(--border);display:flex;flex-direction:column}
.sb-header{display:flex;align-items:center;justify-content:space-between;padding:10px 14px;font-size:9px;font-weight:700;text-transform:uppercase;letter-spacing:1.2px;color:var(--accent)}
.sb-header .refresh{cursor:pointer;color:var(--muted);font-size:12px;transition:color .2s}
.sb-header .refresh:hover{color:var(--accent)}
.sb-body{overflow-y:auto}

/* Project rows */
.proj-row{display:flex;align-items:center;gap:8px;padding:7px 14px;cursor:pointer;transition:background .12s;border-left:3px solid transparent;font-size:12px}
.proj-row:hover{background:var(--surface2)}
.proj-row.active{background:var(--accent-dim);border-left-color:var(--accent)}
.proj-row .dot{width:7px;height:7px;border-radius:50%;flex-shrink:0}
.dot.up{background:var(--green);box-shadow:0 0 4px var(--green)}
.dot.degraded{background:var(--yellow);box-shadow:0 0 4px var(--yellow)}
.dot.down{background:var(--red);box-shadow:0 0 4px var(--red);animation:pulse-dot 1.2s ease infinite}
.dot.unknown{background:var(--muted)}
@keyframes pulse-dot{0%,100%{opacity:1}50%{opacity:.4}}
.proj-row .pname{flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;color:var(--text);font-weight:500}
.proj-row .pdetail{font-size:9px;color:var(--muted);white-space:nowrap}
.proj-row .dev-dot{width:5px;height:5px;border-radius:50%;flex-shrink:0}
.dev-dot.live{background:var(--cyan);box-shadow:0 0 4px var(--cyan)}
.dev-dot.off{background:var(--muted);opacity:.4}

/* Health cards */
.hcard{background:var(--surface2);border:1px solid var(--border);border-radius:7px;margin:0 10px 6px;padding:8px 10px;cursor:pointer;transition:border-color .2s}
.hcard:hover{border-color:var(--accent)}
.hcard.active{border-color:var(--accent);background:var(--accent-dim)}
.hcard-top{display:flex;align-items:center;justify-content:space-between;margin-bottom:3px}
.hcard-name{font-size:12px;font-weight:600;color:var(--text-bright);display:flex;align-items:center;gap:5px}
.hcard-badges{display:flex;gap:3px}
.hbadge{font-size:8px;padding:1px 5px;border-radius:3px;font-weight:700;text-transform:uppercase;letter-spacing:.3px}
.hbadge.up{background:var(--green-dim);color:var(--green)}
.hbadge.down{background:var(--red-dim);color:var(--red)}
.hbadge.degraded{background:var(--yellow-dim);color:var(--yellow)}
.hbadge.unknown{background:#71717a22;color:var(--muted)}
.hbadge.dev-on{background:var(--cyan-dim);color:var(--cyan)}
.hbadge.dev-off{background:#71717a22;color:var(--muted)}
.hbadge.dirty{background:var(--yellow-dim);color:var(--yellow)}
.hcard-row{display:flex;align-items:center;gap:6px;font-size:10px;color:var(--muted)}
.hcard-row .branch{font-family:var(--font-mono);color:var(--cyan);font-weight:600}
.hcard-row .time{margin-left:auto}
.hcard-actions{display:flex;gap:4px;margin-top:5px}
.hcard-btn{background:none;border:1px solid var(--border);border-radius:3px;color:var(--muted);font-size:9px;padding:2px 6px;cursor:pointer;transition:border-color .15s,color .15s}
.hcard-btn:hover{border-color:var(--accent);color:var(--accent)}

/* ── Activity (sidebar, shown in both modes) ── */
.activity-section{flex-shrink:0;max-height:140px;overflow:hidden;display:flex;flex-direction:column}

/* ── Mission Stack (bridge mode only) ── */
.mission-section{flex-shrink:0;max-height:140px;overflow:hidden;display:flex;flex-direction:column;transition:max-height .4s ease, opacity .4s ease;opacity:1}
body.workshop-mode .mission-section{max-height:0;opacity:0;border:none;overflow:hidden}

/* ── Bridge/Workshop only buttons ── */
body.workshop-mode .bridge-only{display:none}
body.bridge-mode .workshop-only{display:none}

/* ═══ CENTER AREA ═════════════════════════════════════════════════════════ */
.center{display:flex;flex-direction:column;overflow:hidden;position:relative;background:var(--bg)}

/* Center topbar */
.center-header{height:38px;background:var(--surface);border-bottom:1px solid var(--border);display:flex;align-items:center;padding:0 14px;gap:10px;flex-shrink:0;transition:opacity .4s ease}
.center-header .proj-label{font-size:13px;font-weight:700;color:var(--text-bright);flex:1}
.center-header .branch-tag{font-family:var(--font-mono);font-size:11px;color:var(--cyan);background:var(--cyan-dim);padding:2px 8px;border-radius:4px}
.center-header .dirty-tag{font-size:10px;color:var(--yellow);font-weight:600}
.center-header .dev-url{font-size:10px;color:var(--green)}
.ch-btn{background:none;border:1px solid var(--border);color:var(--muted);padding:3px 10px;border-radius:4px;cursor:pointer;font-size:10px;font-weight:600;transition:all .2s}
.ch-btn:hover{border-color:var(--accent);color:var(--accent);background:var(--accent-dim)}
.ch-btn:disabled{opacity:.3;cursor:not-allowed}

/* Center body: stacked layers */
.center-body{flex:1;position:relative;overflow:hidden}

/* ── Bridge Layer (Jarvis orbital) ── */
.bridge-layer{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;transition:opacity .5s cubic-bezier(.4,0,.2,1),transform .5s cubic-bezier(.4,0,.2,1);z-index:1}
body.workshop-mode .bridge-layer{opacity:0;transform:scale(.96);pointer-events:none}
body.bridge-mode .bridge-layer{opacity:1;transform:scale(1)}
/* Athena ghost mode: keep bridge layer visible (very dim) behind workshop content */
body.workshop-mode.athena-scene-active .bridge-layer{opacity:1;transform:scale(1);z-index:0}

/* ── Workshop Layer (file tree + windows) ── */
.workshop-layer{position:absolute;inset:0;display:grid;grid-template-columns:240px 1fr;overflow:hidden;transition:opacity .5s cubic-bezier(.4,0,.2,1),transform .5s cubic-bezier(.4,0,.2,1);z-index:2}
body.bridge-mode .workshop-layer{opacity:0;transform:scale(1.02);pointer-events:none}
body.workshop-mode .workshop-layer{opacity:1;transform:scale(1)}

/* File tree */
.file-tree{background:var(--surface);border-right:1px solid var(--border);overflow-y:auto;font-size:12px}
.ft-header{padding:8px 12px;font-size:9px;font-weight:700;text-transform:uppercase;letter-spacing:1px;color:var(--accent);border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center}
.ft-header .ft-count{color:var(--muted);font-weight:500;text-transform:none;letter-spacing:0}
.ft-empty{padding:14px;color:var(--muted);font-style:italic;font-size:11px;text-align:center}
.ft-dir{padding:5px 12px;font-size:10px;font-weight:600;color:var(--muted);text-transform:uppercase;letter-spacing:.4px;display:flex;align-items:center;gap:4px;margin-top:4px}
.ft-file{display:flex;align-items:center;gap:6px;padding:4px 12px 4px 24px;cursor:pointer;transition:background .12s;font-family:var(--font-mono);font-size:11px}
.ft-file:hover{background:var(--surface2)}
.ft-file.active{background:var(--accent-dim);color:var(--accent)}
.ft-file .ficon{font-size:10px;flex-shrink:0}
.ft-file .fname{flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.ft-file .fstat{font-size:9px;font-weight:700;flex-shrink:0}
.ft-file .fstat.M{color:var(--yellow)}
.ft-file .fstat.A{color:var(--green)}
.ft-file .fstat.D{color:var(--red)}
.ft-file .fstat.U{color:var(--orange)}

/* Window area */
.win-area{position:relative;overflow:hidden;background:var(--bg)}
.win-empty{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;color:var(--muted);font-size:13px;font-style:italic}

/* ═══ JARVIS ORBITAL VISUALIZATION ═══════════════════════════════════════ */
.jarvis-container{position:relative;width:500px;height:500px}
.jarvis-canvas{width:100%;height:100%}
.jarvis-status{position:absolute;bottom:0;left:50%;transform:translateX(-50%);font-size:12px;letter-spacing:3px;color:var(--muted);text-transform:uppercase;font-weight:600}

/* ═══ FLOATING WINDOWS ═══════════════════════════════════════════════════ */
.float-win{position:absolute;background:var(--surface);border:1px solid var(--border);border-radius:8px;box-shadow:0 8px 32px rgba(0,0,0,.5);display:flex;flex-direction:column;min-width:400px;min-height:250px;overflow:hidden;transition:box-shadow .15s}
.float-win.focused{border-color:var(--accent);box-shadow:0 8px 32px rgba(0,0,0,.5),0 0 0 1px var(--accent)}
.float-win.unfocused{opacity:.85}
.fw-titlebar{height:32px;background:var(--surface2);border-bottom:1px solid var(--border);display:flex;align-items:center;padding:0 10px;cursor:move;flex-shrink:0;gap:8px}
.fw-titlebar .fw-icon{font-size:12px}
.fw-titlebar .fw-title{flex:1;font-size:11px;font-weight:600;color:var(--text);overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.fw-titlebar .fw-close{background:none;border:none;color:var(--muted);cursor:pointer;font-size:14px;padding:0 4px;transition:color .15s}
.fw-titlebar .fw-close:hover{color:var(--red)}
.fw-body{flex:1;overflow:auto;padding:0}

/* Diff viewer inside window */
.diff-view{font-family:var(--font-mono);font-size:11px;line-height:1.6;padding:0}
.diff-hunk{color:var(--cyan);padding:4px 10px;background:var(--cyan-dim);font-weight:600;font-size:10px}
.diff-file-header{color:var(--accent);padding:6px 10px;background:var(--accent-dim);font-weight:700;font-size:11px;border-bottom:1px solid var(--border)}
.diff-line{padding:0 10px;white-space:pre-wrap;word-break:break-all}
.diff-line.add{background:#22c55e12;color:#86efac}
.diff-line.del{background:#ef444412;color:#fca5a5}
.diff-line.ctx{color:var(--muted)}

/* Terminal output inside window */
.term-view{font-family:var(--font-mono);font-size:11px;line-height:1.5;padding:10px;color:var(--green);background:#111;min-height:100%;white-space:pre-wrap;word-break:break-all}
.term-view.error{color:var(--red)}
.term-view .term-cmd{color:var(--accent);font-weight:600;margin-bottom:4px}

/* Commit viewer inside window */
.commit-view{padding:16px}
.commit-view label{display:block;font-size:10px;color:var(--muted);text-transform:uppercase;letter-spacing:.5px;margin-bottom:4px;font-weight:600}
.commit-view input,.commit-view textarea{width:100%;background:var(--bg);border:1px solid var(--border);color:var(--text);padding:8px 10px;border-radius:5px;font-family:inherit;font-size:12px;margin-bottom:12px}
.commit-view input:focus,.commit-view textarea:focus{outline:none;border-color:var(--accent)}
.commit-view textarea{min-height:80px;resize:vertical}
.commit-view .file-list{max-height:150px;overflow-y:auto;font-family:var(--font-mono);font-size:11px;color:var(--muted);border:1px solid var(--border);border-radius:5px;padding:6px 10px;margin-bottom:12px;background:var(--bg)}
.commit-view .cv-actions{display:flex;gap:8px;justify-content:flex-end}
.cv-btn{padding:6px 16px;border-radius:5px;font-size:12px;font-weight:600;cursor:pointer;transition:all .2s;border:none}
.cv-btn.primary{background:var(--accent);color:var(--bg)}
.cv-btn.primary:hover{background:var(--accent2)}
.cv-btn.outline{background:none;border:1px solid var(--border);color:var(--muted)}
.cv-btn.outline:hover{border-color:var(--accent);color:var(--accent)}
.cv-btn:disabled{opacity:.4;cursor:not-allowed}

/* ═══ RIGHT PANEL (CHAT) ═════════════════════════════════════════════════ */
.right-panel{background:var(--surface);border-left:1px solid var(--border);display:flex;flex-direction:column;overflow:hidden}
.chat-header{padding:10px 14px;border-bottom:1px solid var(--border);display:flex;flex-direction:column;gap:6px}
.chat-header-top{display:flex;align-items:center;justify-content:space-between}
.chat-header-title{font-size:13px;font-weight:700;color:var(--text-bright)}
.chat-clear{background:none;border:1px solid var(--border);color:var(--muted);padding:2px 8px;border-radius:3px;cursor:pointer;font-size:10px;transition:all .2s}
.chat-clear:hover{border-color:var(--red);color:var(--red)}
.chat-ctx{font-size:10px;color:var(--muted);line-height:1.4}
.chat-ctx span{color:var(--text)}
.chat-ctx .ctx-branch{color:var(--cyan);font-family:var(--font-mono)}
.chat-ctx .ctx-url{color:var(--green)}
.chat-messages{flex:1;overflow-y:auto;padding:14px;display:flex;flex-direction:column;gap:10px}
.msg{max-width:90%;padding:8px 12px;border-radius:10px;font-size:12px;line-height:1.5;white-space:pre-wrap;word-break:break-word}
.msg.user{align-self:flex-end;background:var(--accent);color:var(--bg);border-bottom-right-radius:3px;font-weight:500}
.msg.assistant{align-self:flex-start;background:var(--surface2);border:1px solid var(--border);border-bottom-left-radius:3px}
.msg .msg-time{font-size:8px;color:var(--muted);margin-top:3px;text-align:right}
.msg.user .msg-time{color:rgba(0,0,0,.35)}
.msg.streaming::after{content:'▌';animation:blink .8s infinite}
@keyframes blink{0%,100%{opacity:1}50%{opacity:0}}
.chat-input-area{padding:10px 14px;border-top:1px solid var(--border);display:flex;flex-direction:column;gap:6px}
.chat-actions{display:flex;gap:6px;flex-wrap:wrap;transition:max-height .4s ease, opacity .4s ease;overflow:hidden}
body.bridge-mode .chat-actions{max-height:0;opacity:0;margin:0;padding:0}
body.workshop-mode .chat-actions{max-height:60px;opacity:1}
.ca-btn{padding:4px 10px;border-radius:4px;font-size:10px;font-weight:600;cursor:pointer;transition:all .15s;border:1px solid var(--border);background:var(--surface2);color:var(--text)}
.ca-btn:hover:not(:disabled){border-color:var(--accent);color:var(--accent);background:var(--accent-dim)}
.ca-btn:disabled{opacity:.3;cursor:not-allowed}
.ca-btn.running{color:var(--yellow);border-color:var(--yellow);animation:pulse-dot 1.5s ease infinite}
.chat-row{display:flex;gap:6px}
.chat-input{flex:1;background:var(--bg);border:1px solid var(--border);color:var(--text);padding:8px 12px;border-radius:6px;font-size:12px;font-family:inherit;outline:none}
.chat-input:focus{border-color:var(--accent)}
.chat-send{width:36px;height:36px;border-radius:50%;background:var(--accent);border:none;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .2s;flex-shrink:0}
.chat-send:hover{background:var(--accent2)}
.chat-send svg{fill:var(--bg);width:16px;height:16px}
.chat-agent-row{display:flex;align-items:center;gap:6px}
.chat-agent-sel{background:var(--bg);border:1px solid var(--border);color:var(--text);padding:3px 6px;border-radius:4px;font-size:11px;outline:none}
.chat-agent-desc{font-size:10px;color:var(--muted);font-style:italic}

/* ═══ BOTTOM BAR ══════════════════════════════════════════════════════════ */
.bottom-bar{height:24px;background:var(--surface);border-top:1px solid var(--border);display:flex;align-items:center;padding:0 14px;gap:12px;flex-shrink:0;font-size:10px;color:var(--muted)}
.bb-item{display:flex;align-items:center;gap:4px}
.bb-dot{width:5px;height:5px;border-radius:50%}

/* ═══ SCROLLBAR ═══════════════════════════════════════════════════════════ */
::-webkit-scrollbar{width:5px}
::-webkit-scrollbar-track{background:transparent}
::-webkit-scrollbar-thumb{background:var(--border);border-radius:3px}
::-webkit-scrollbar-thumb:hover{background:var(--muted)}

/* ═══ MODE TOGGLE MORPH ANIMATION ═════════════════════════════════════════ */
@keyframes tagMorph{
  0%{opacity:0;transform:translateY(-4px) scale(0.9)}
  100%{opacity:1;transform:translateY(0) scale(1)}
}
.logo-tag.morphing{animation:tagMorph .35s ease-out forwards}

/* page transition CSS (kept for compatibility with old tests) */
@keyframes pageExit{
  from{opacity:1;transform:scale(1);filter:blur(0)}
  to{opacity:0;transform:scale(0.97);filter:blur(3px)}
}
@keyframes pageEnter{
  from{opacity:0;transform:scale(1.02);filter:blur(2px)}
  to{opacity:1;transform:scale(1);filter:blur(0)}
}
@keyframes topbarSlide{
  from{opacity:0.5;transform:translateY(-2px)}
  to{opacity:1;transform:translateY(0)}
}
body.page-exit-active>*:not(.topbar){animation:pageExit 300ms ease forwards;pointer-events:none}
body.page-exit-active .topbar{transition:opacity 250ms ease;opacity:0.6}
body.page-exit-active .topbar .logo-tag{transition:transform 200ms ease,opacity 200ms ease;transform:scale(0.85);opacity:0}
body.page-enter-active>*{opacity:0}
body.page-enter-ready .topbar{animation:topbarSlide 200ms ease-out forwards}
body.page-enter-ready .topbar .logo-tag{animation:tagMorph 350ms ease-out 50ms forwards;opacity:0}
body.page-enter-ready>*:not(.topbar){animation:pageEnter 350ms ease-out 100ms forwards;opacity:0}

/* ═══ Workshop-only center header visibility ═════════════════════════════ */
body.bridge-mode .center-header{opacity:.4;pointer-events:none}
body.workshop-mode .center-header{opacity:1;pointer-events:auto}

/* ═══ TASK BOARD OVERLAY ═════════════════════════════════════════════════ */
.board-overlay{position:fixed;inset:0;background:rgba(0,0,0,.75);z-index:900;display:none;align-items:stretch;justify-content:center;padding:40px 20px}
.board-overlay.open{display:flex}
.board-container{background:var(--bg);border:1px solid var(--border);border-radius:10px;width:100%;max-width:1400px;display:flex;flex-direction:column;overflow:hidden}
.board-header{display:flex;align-items:center;justify-content:space-between;padding:12px 20px;border-bottom:1px solid var(--border);flex-shrink:0}
.board-title{font-size:16px;font-weight:800;color:var(--text-bright);letter-spacing:1px}
.board-header-right{display:flex;align-items:center;gap:8px}
.board-filter{background:var(--surface);border:1px solid var(--border);color:var(--text);padding:4px 10px;border-radius:4px;font-size:11px;outline:none}
.board-close{background:none;border:1px solid var(--border);color:var(--muted);width:28px;height:28px;border-radius:4px;cursor:pointer;font-size:16px;display:flex;align-items:center;justify-content:center;transition:all .15s}
.board-close:hover{border-color:var(--red);color:var(--red)}
.board-body{flex:1;display:grid;grid-template-columns:repeat(5,1fr);gap:10px;padding:14px;overflow-x:auto}
.board-col{background:var(--surface);border:1px solid var(--border);border-radius:7px;display:flex;flex-direction:column;min-width:200px;overflow:hidden}
.board-col-header{padding:8px 12px;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:1px;flex-shrink:0}
.board-col-header.backlog{color:var(--muted)}
.board-col-header.planned{color:var(--blue)}
.board-col-header.in-progress{color:var(--yellow)}
.board-col-header.review{color:var(--purple)}
.board-col-header.done{color:var(--green)}
.col-count{background:var(--surface2);padding:1px 6px;border-radius:3px;font-size:10px;font-weight:700}
.board-col-body{flex:1;overflow-y:auto;padding:6px}
.board-col-add{padding:6px 12px;border-top:1px solid var(--border)}
.board-col-add button{width:100%;background:none;border:1px dashed var(--border);color:var(--muted);padding:4px;border-radius:4px;cursor:pointer;font-size:11px;transition:all .15s}
.board-col-add button:hover{border-color:var(--accent);color:var(--accent)}

/* Task card */
.task-card{background:var(--surface2);border:1px solid var(--border);border-radius:5px;padding:8px 10px;margin-bottom:6px;cursor:pointer;transition:all .15s}
.task-card:hover{border-color:var(--accent);transform:translateY(-1px);box-shadow:0 2px 8px rgba(0,0,0,.2)}
.task-card .tc-title{font-size:11px;font-weight:600;color:var(--text-bright);margin-bottom:3px;display:flex;align-items:flex-start;gap:4px}
.task-card .tc-title .tc-priority{font-size:8px;flex-shrink:0;margin-top:2px}
.tc-priority.urgent{color:var(--red)}
.tc-priority.high{color:var(--orange)}
.tc-meta{display:flex;align-items:center;gap:5px;font-size:9px;color:var(--muted);flex-wrap:wrap}
.tc-meta .tc-agent{color:var(--accent);font-weight:600}
.tc-meta .tc-project{color:var(--cyan);font-weight:600}
.tc-autopilot{display:inline-flex;align-items:center;gap:2px;color:var(--yellow);font-size:8px;font-weight:700;text-transform:uppercase;letter-spacing:.3px}
.task-card .tc-actions{display:flex;gap:3px;margin-top:5px;opacity:0;transition:opacity .15s}
.task-card:hover .tc-actions{opacity:1}
.tc-act{background:none;border:1px solid var(--border);color:var(--muted);padding:2px 6px;border-radius:3px;cursor:pointer;font-size:9px;transition:all .15s}
.tc-act:hover{border-color:var(--accent);color:var(--accent)}
.tc-act.del:hover{border-color:var(--red);color:var(--red)}

/* New task form */
.new-task-form{padding:10px;border:1px solid var(--accent);border-radius:5px;background:var(--surface);margin:6px 0}
.new-task-form input,.new-task-form textarea,.new-task-form select{width:100%;background:var(--bg);border:1px solid var(--border);color:var(--text);padding:5px 8px;border-radius:4px;font-size:11px;margin-bottom:6px;font-family:inherit}
.new-task-form input:focus,.new-task-form textarea:focus{outline:none;border-color:var(--accent)}
.new-task-form textarea{min-height:40px;resize:vertical}
.ntf-row{display:flex;gap:5px}
.ntf-row select{flex:1}
.ntf-actions{display:flex;gap:5px;justify-content:flex-end}
.ntf-btn{padding:4px 12px;border-radius:4px;font-size:10px;font-weight:600;cursor:pointer;border:none}
.ntf-btn.save{background:var(--accent);color:var(--bg)}
.ntf-btn.save:hover{background:var(--accent2)}
.ntf-btn.cancel{background:none;border:1px solid var(--border);color:var(--muted)}
.ntf-btn.cancel:hover{border-color:var(--red);color:var(--red)}

/* Push/PR */
.pr-result{padding:12px;font-size:12px}
.pr-result a{color:var(--accent);font-weight:600}
.pr-result .pr-url{font-family:var(--font-mono);font-size:11px;background:var(--bg);padding:4px 8px;border-radius:4px;display:inline-block;margin-top:6px}

/* ═══ USAGE OVERLAY ══════════════════════════════════════════════════════ */
.usage-overlay{position:fixed;inset:0;background:rgba(0,0,0,.75);z-index:900;display:none;align-items:center;justify-content:center;padding:40px 20px}
.usage-overlay.open{display:flex}
.usage-container{background:var(--bg);border:1px solid var(--border);border-radius:10px;width:100%;max-width:700px;max-height:80vh;display:flex;flex-direction:column;overflow:hidden}
.usage-header{display:flex;align-items:center;justify-content:space-between;padding:12px 20px;border-bottom:1px solid var(--border)}
.usage-title{font-size:16px;font-weight:800;color:var(--text-bright);letter-spacing:1px}
.usage-body{flex:1;overflow-y:auto;padding:16px 20px;display:flex;flex-direction:column;gap:16px}
.usage-card{background:var(--surface);border:1px solid var(--border);border-radius:7px;padding:14px}
.usage-card-title{font-size:10px;font-weight:700;text-transform:uppercase;letter-spacing:1px;color:var(--accent);margin-bottom:8px}
.usage-bar-wrap{height:8px;background:var(--surface2);border-radius:4px;overflow:hidden;margin:6px 0}
.usage-bar{height:100%;border-radius:4px;transition:width .5s}
.usage-bar.ok{background:var(--green)}
.usage-bar.warn{background:var(--yellow)}
.usage-bar.crit{background:var(--red)}
.usage-stat{display:flex;justify-content:space-between;font-size:11px;color:var(--muted)}
.usage-stat .val{color:var(--text-bright);font-weight:600;font-family:var(--font-mono)}
.usage-models{display:grid;grid-template-columns:1fr 1fr;gap:8px}
.usage-model-item{background:var(--surface2);border-radius:5px;padding:8px 10px;font-size:11px}
.usage-model-item .model-name{color:var(--text-bright);font-weight:600;font-size:10px;margin-bottom:2px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.usage-model-item .model-tokens{color:var(--accent);font-family:var(--font-mono);font-weight:600}

/* ═══ ORCHESTRATOR OVERLAY ════════════════════════════════════════════════ */
.orch-overlay{position:fixed;inset:0;background:rgba(0,0,0,.75);z-index:900;display:none;align-items:center;justify-content:center;padding:40px 20px}
.orch-overlay.open{display:flex}
.orch-container{background:var(--bg);border:1px solid var(--border);border-radius:10px;width:100%;max-width:800px;max-height:85vh;display:flex;flex-direction:column;overflow:hidden}
.orch-header{display:flex;align-items:center;justify-content:space-between;padding:12px 20px;border-bottom:1px solid var(--border)}
.orch-title{font-size:16px;font-weight:800;color:var(--text-bright);letter-spacing:1px}
.orch-body{flex:1;overflow-y:auto;padding:16px 20px;display:flex;flex-direction:column;gap:12px}
.orch-input-area{padding:12px 20px;border-bottom:1px solid var(--border);display:flex;flex-direction:column;gap:8px}
.orch-textarea{width:100%;min-height:60px;background:var(--bg);border:1px solid var(--border);color:var(--text);padding:10px;border-radius:6px;font-family:inherit;font-size:12px;resize:vertical}
.orch-textarea:focus{outline:none;border-color:var(--accent)}
.orch-actions{display:flex;gap:8px;align-items:center}
.orch-run{padding:6px 20px;border-radius:5px;font-size:12px;font-weight:600;cursor:pointer;border:none;background:var(--accent);color:var(--bg);transition:all .2s}
.orch-run:hover{background:var(--accent2)}
.orch-run:disabled{opacity:.4;cursor:not-allowed}
.orch-status{font-size:11px;color:var(--muted);flex:1}
.orch-phase{background:var(--surface);border:1px solid var(--border);border-radius:6px;padding:10px 14px}
.orch-phase-title{font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:.5px;margin-bottom:4px;display:flex;align-items:center;gap:6px}
.orch-phase-title.planning{color:var(--blue)}
.orch-phase-title.executing{color:var(--yellow)}
.orch-phase-title.reviewing{color:var(--purple)}
.orch-phase-title.synthesizing{color:var(--cyan)}
.orch-phase-title.done{color:var(--green)}
.orch-phase-title.error{color:var(--red)}
.orch-phase-detail{font-size:12px;color:var(--text);line-height:1.5;white-space:pre-wrap;word-break:break-word;max-height:200px;overflow-y:auto}
.orch-subtask{background:var(--surface2);border:1px solid var(--border);border-radius:5px;padding:8px 12px;margin-left:16px}
.orch-subtask-header{display:flex;align-items:center;gap:6px;font-size:11px;margin-bottom:4px}
.orch-subtask-header .agent-tag{color:var(--accent);font-weight:700}
.orch-subtask-header .status-tag{font-weight:600}
.orch-subtask-header .status-tag.done{color:var(--green)}
.orch-subtask-header .status-tag.running{color:var(--yellow)}
.orch-subtask-header .status-tag.error{color:var(--red)}
.orch-subtask-result{font-size:11px;color:var(--muted);font-family:var(--font-mono);white-space:pre-wrap;max-height:100px;overflow-y:auto;margin-top:4px}
.orch-final{background:var(--green-dim);border:1px solid var(--green);border-radius:6px;padding:14px}
.orch-final-title{font-size:11px;font-weight:700;color:var(--green);text-transform:uppercase;letter-spacing:.5px;margin-bottom:6px}
.orch-final-text{font-size:12px;color:var(--text);line-height:1.5;white-space:pre-wrap;word-break:break-word;max-height:300px;overflow-y:auto}

/* ═══ MEMORY OVERLAY ═════════════════════════════════════════════════════ */
.mem-overlay{position:fixed;inset:0;background:rgba(0,0,0,.75);z-index:900;display:none;align-items:center;justify-content:center;padding:40px 20px}
.mem-overlay.open{display:flex}
.mem-container{background:var(--bg);border:1px solid var(--border);border-radius:10px;width:100%;max-width:700px;max-height:85vh;display:flex;flex-direction:column;overflow:hidden}
.mem-header{display:flex;align-items:center;justify-content:space-between;padding:12px 20px;border-bottom:1px solid var(--border)}
.mem-title{font-size:16px;font-weight:800;color:var(--text-bright);letter-spacing:1px}
.mem-toolbar{display:flex;align-items:center;gap:8px;padding:10px 20px;border-bottom:1px solid var(--border)}
.mem-agent-sel{background:var(--surface);border:1px solid var(--border);color:var(--text);padding:4px 10px;border-radius:4px;font-size:11px;outline:none}
.mem-search-input{flex:1;background:var(--surface);border:1px solid var(--border);color:var(--text);padding:5px 10px;border-radius:4px;font-size:11px;outline:none}
.mem-search-input:focus{border-color:var(--accent)}
.mem-search-btn{background:var(--accent);border:none;color:var(--bg);padding:5px 12px;border-radius:4px;font-size:11px;font-weight:600;cursor:pointer}
.mem-search-btn:hover{background:var(--accent2)}
.mem-body{flex:1;overflow-y:auto;padding:12px 20px}
.mem-empty{color:var(--muted);font-size:12px;font-style:italic;text-align:center;padding:20px}
.mem-item{background:var(--surface);border:1px solid var(--border);border-radius:5px;padding:10px 12px;margin-bottom:6px;font-size:12px;color:var(--text);line-height:1.4}
.mem-item .mem-meta{font-size:9px;color:var(--muted);margin-top:4px;display:flex;gap:8px}
.mem-add-area{padding:10px 20px;border-top:1px solid var(--border);display:flex;gap:6px}
.mem-add-input{flex:1;background:var(--surface);border:1px solid var(--border);color:var(--text);padding:6px 10px;border-radius:4px;font-size:11px;outline:none}
.mem-add-input:focus{border-color:var(--accent)}
.mem-add-btn{background:var(--accent);border:none;color:var(--bg);padding:6px 14px;border-radius:4px;font-size:11px;font-weight:600;cursor:pointer}
.mem-add-btn:hover{background:var(--accent2)}
.mem-clear-btn{background:none;border:1px solid var(--red);color:var(--red);padding:5px 12px;border-radius:4px;font-size:10px;font-weight:600;cursor:pointer;transition:all .2s}
.mem-clear-btn:hover{background:var(--red);color:var(--bg)}
.mem-stats{font-size:10px;color:var(--muted);padding:4px 0}
.usage-charts{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-bottom:12px}
.usage-chart-box{background:var(--surface2);border:1px solid var(--border);border-radius:6px;padding:12px}
.usage-chart-label{font-size:9px;font-weight:700;text-transform:uppercase;letter-spacing:1px;color:var(--accent);margin-bottom:8px}
.usage-refresh-bar{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px}
.usage-refresh-btn{background:none;border:1px solid var(--border);color:var(--muted);padding:3px 10px;border-radius:4px;font-size:10px;cursor:pointer;transition:all .2s}
.usage-refresh-btn:hover{border-color:var(--accent);color:var(--accent)}
.usage-auto-tag{font-size:9px;color:var(--muted)}
</style>
<script src="https://cdn.jsdelivr.net/npm/chart.js@4/dist/chart.umd.min.js"></script>
</head>
<body class="bridge-mode">

<!-- TOP BAR -->
<div class="topbar">
  <div class="topbar-left">
    <span class="logo">Athena</span>
    <span class="logo-tag" id="modeTag" onclick="toggleMode()">THE BRIDGE</span>
  </div>
  <div class="topbar-right">
    <div class="status-pill ok" id="apiStatus"><span class="sd"></span><span>API</span></div>
    <div class="status-pill off" id="runnerStatus"><span class="sd"></span><span>Runner</span><span id="runnerInfo" style="font-size:9px">—</span></div>
    <button class="tb-btn" id="tbBoard" onclick="toggleTaskBoard()">&#9744; Board</button>
    <button class="tb-btn" onclick="toggleUsage()">&#128200; Usage</button>
    <button class="tb-btn" onclick="toggleOrchestrator()">&#9889; Mission</button>
    <button class="tb-btn" onclick="toggleMemory()">&#128065; Memory</button>
    <button class="tb-btn bridge-only" onclick="navigateToWorkshop()">&#128736; Workshop</button>
    <button class="tb-btn workshop-only" onclick="navigateToBridge()">&#127758; Bridge</button>
    <button class="tb-btn" onclick="refreshAll()">&#8635; Refresh</button>
    <span class="clock" id="clock"></span>
    <span class="build-sha" id="buildSha" title="Build SHA">—</span>
  </div>
</div>

<!-- MAIN LAYOUT -->
<div class="layout">

  <!-- ─── LEFT SIDEBAR ──────────────────────────────────────────────── -->
  <div class="sidebar">
    <!-- Projects -->
    <div class="sb-section" style="flex:1;overflow:hidden;display:flex;flex-direction:column">
      <div class="sb-header">Projects <span class="refresh" onclick="loadProjects()">&#8635;</span></div>
      <div class="sb-body" id="projectList" style="flex:1;overflow-y:auto"></div>
    </div>
    <!-- Health -->
    <div class="sb-section" style="max-height:280px;overflow:hidden;display:flex;flex-direction:column">
      <div class="sb-header">Project Health <span class="refresh" onclick="loadProjects()">&#8635;</span></div>
      <div class="sb-body" id="healthList" style="flex:1;overflow-y:auto;padding-bottom:6px"></div>
    </div>
    <!-- Mission Stack (Bridge only) -->
    <div class="sb-section mission-section">
      <div class="sb-header">Mission Stack</div>
      <div class="sb-body" id="missionStack" style="flex:1;overflow-y:auto;padding:4px 10px">
        <div style="color:var(--muted);font-size:11px;font-style:italic;padding:6px 0">No active missions</div>
      </div>
    </div>
    <!-- Activity -->
    <div class="sb-section activity-section">
      <div class="sb-header">Activity</div>
      <div class="sb-body" id="activityFeed" style="flex:1;overflow-y:auto;padding:4px 10px">
        <div style="color:var(--muted);font-size:11px;font-style:italic;padding:6px 0">No recent activity</div>
      </div>
    </div>
  </div>

  <!-- ─── CENTER ────────────────────────────────────────────────────── -->
  <div class="center">
    <div class="center-header" id="centerHeader">
      <span class="proj-label" id="focusedLabel">No project selected</span>
    </div>
    <div class="center-body">
      <!-- Bridge Layer: Jarvis Orbital -->
      <div class="bridge-layer" id="bridgeLayer">
        <div class="jarvis-container">
          <canvas class="jarvis-canvas" id="jarvisCanvas"></canvas>
          <div class="jarvis-status" id="jarvisStatus">IDLE</div>
        </div>
      </div>
      <!-- Workshop Layer: File Tree + Windows -->
      <div class="workshop-layer" id="workshopLayer">
        <div class="file-tree" id="fileTreePanel">
          <div class="ft-header">Changed Files <span class="ft-count" id="ftCount">0</span></div>
          <div id="fileTree"><div class="ft-empty">Select a project to see changes</div></div>
        </div>
        <div class="win-area" id="winArea">
          <div class="win-empty" id="winEmpty">Click a file to view its diff, or use action buttons</div>
        </div>
      </div>
    </div>
  </div>

  <!-- ─── RIGHT PANEL (CHAT) ────────────────────────────────────────── -->
  <div class="right-panel">
    <div class="chat-header">
      <div class="chat-header-top">
        <span class="chat-header-title" id="chatTitle">Conversation</span>
        <button class="chat-clear" onclick="clearChat()">Clear</button>
      </div>
      <div class="chat-ctx" id="chatCtx">Select a project to begin</div>
    </div>
    <div class="chat-messages" id="chatMessages"></div>
    <div class="chat-input-area">
      <div class="chat-actions" id="workshopActions">
        <button class="ca-btn" id="btnLaunch" onclick="launchDev()" disabled>&#9654; Launch</button>
        <button class="ca-btn" id="btnStage" onclick="stageFiles()" disabled>&#43; Stage All</button>
        <button class="ca-btn" id="btnCommit" onclick="generateCommit()" disabled>&#128221; Generate Commit</button>
        <button class="ca-btn" id="btnTests" onclick="runTests()" disabled>&#9989; Tests</button>
        <button class="ca-btn" id="btnPushPR" onclick="pushAndPR()" disabled>&#128640; Push &amp; PR</button>
      </div>
      <div class="chat-agent-row">
        <select class="chat-agent-sel" id="agentSelect">
          <!-- Populated dynamically by loadAgentList() from GET /api/agents -->
        </select>
        <span class="chat-agent-desc" id="agentDesc">Central coordinator</span>
      </div>
      <div class="chat-row">
        <input class="chat-input" id="chatInput" placeholder="Type a message..." onkeydown="if(event.key==='Enter')sendChat()">
        <button class="chat-send" onclick="sendChat()">
          <svg viewBox="0 0 24 24"><path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/></svg>
        </button>
      </div>
    </div>
  </div>
</div>

<!-- BOTTOM BAR -->
<div class="bottom-bar">
  <div class="bb-item"><span class="bb-dot" style="background:var(--green)" id="bbApiDot"></span> API</div>
  <div class="bb-item"><span class="bb-dot" id="bbRunnerDot" style="background:var(--muted)"></span> Runner</div>
  <div class="bb-item" id="bbFocused">—</div>
  <div style="flex:1"></div>
  <div class="bb-item" id="bbHealth">—</div>
</div>

<!-- TASK BOARD OVERLAY -->
<div class="board-overlay" id="boardOverlay">
  <div class="board-container">
    <div class="board-header">
      <span class="board-title">&#9744; Task Board</span>
      <div class="board-header-right">
        <select class="board-filter" id="boardProjectFilter" onchange="loadBoard()">
          <option value="">All projects</option>
        </select>
        <button class="board-close" onclick="toggleTaskBoard()">&times;</button>
      </div>
    </div>
    <div class="board-body" id="boardBody"></div>
  </div>
</div>

<!-- USAGE OVERLAY -->
<div class="usage-overlay" id="usageOverlay">
  <div class="usage-container">
    <div class="usage-header">
      <span class="usage-title">&#128200; Usage &amp; Budget</span>
      <button class="board-close" onclick="toggleUsage()">&times;</button>
    </div>
    <div class="usage-body" id="usageBody">
      <div style="color:var(--muted);font-size:12px;text-align:center;padding:20px">Loading...</div>
    </div>
  </div>
</div>

<!-- ORCHESTRATOR OVERLAY -->
<div class="orch-overlay" id="orchOverlay">
  <div class="orch-container">
    <div class="orch-header">
      <span class="orch-title">&#9889; Run Mission</span>
      <button class="board-close" onclick="toggleOrchestrator()">&times;</button>
    </div>
    <div class="orch-input-area">
      <textarea class="orch-textarea" id="orchInput" placeholder="Describe the mission for the agent team..."></textarea>
      <div class="orch-actions">
        <button class="orch-run" id="orchRunBtn" onclick="runMission()">&#9654; Run Mission</button>
        <span class="orch-status" id="orchStatus"></span>
      </div>
    </div>
    <div class="orch-body" id="orchBody">
      <div style="color:var(--muted);font-size:12px;text-align:center;padding:20px;font-style:italic">Enter a task and click Run to start the multi-agent orchestrator</div>
    </div>
  </div>
</div>

<!-- INCIDENTS OVERLAY -->
<div class="usage-overlay" id="incidentsOverlay">
  <div class="usage-container">
    <div class="usage-header">
      <span class="usage-title">&#9888; Incidents &amp; History</span>
      <button class="board-close" onclick="closeIncidents()">&times;</button>
    </div>
    <div class="usage-body" id="incidentsBody">
      <div style="color:var(--muted);font-size:12px;text-align:center;padding:20px">Loading...</div>
    </div>
  </div>
</div>

<!-- MEMORY OVERLAY -->
<div class="mem-overlay" id="memOverlay">
  <div class="mem-container">
    <div class="mem-header">
      <span class="mem-title">&#128065; Agent Memory</span>
      <button class="board-close" onclick="toggleMemory()">&times;</button>
    </div>
    <div class="mem-toolbar">
      <select class="mem-agent-sel" id="memAgentSelect" onchange="loadMemories()"></select>
      <input class="mem-search-input" id="memSearchInput" placeholder="Search memories..." onkeydown="if(event.key==='Enter')searchMemories()">
      <button class="mem-search-btn" onclick="searchMemories()">Search</button>
      <button class="mem-clear-btn" onclick="clearMemories()">Clear All</button>
    </div>
    <div class="mem-body" id="memBody">
      <div class="mem-empty">Select an agent to view memories</div>
    </div>
    <div class="mem-add-area">
      <input class="mem-add-input" id="memAddInput" placeholder="Add a new memory..." onkeydown="if(event.key==='Enter')addMemory()">
      <button class="mem-add-btn" onclick="addMemory()">Add</button>
    </div>
  </div>
</div>

<!-- ═══════════════════════════════════════════════════════════════════════════
     ATHENA SCENE MODULES (must load before inline script)
     ═══════════════════════════════════════════════════════════════════════════ -->
<script src="/static/sprites.js"></script>
<script src="/static/scene.js"></script>
<script src="/static/office.js"></script>

<!-- ═══════════════════════════════════════════════════════════════════════════
     JAVASCRIPT
     ═══════════════════════════════════════════════════════════════════════════ -->
<script>
const API = '/api';

// ─── SCENE FEATURE FLAGS ──────────────────────────────────────────────────────
// OFFICE_SCENE = true  → pixel office (walking agents, desks, tilemap)
// ATHENA_SCENE = true  → geometric orbit scene (fallback when OFFICE_SCENE=false)
// Both false           → original Jarvis orbital
const OFFICE_SCENE = true;
const ATHENA_SCENE = true;   // used only when OFFICE_SCENE = false
let athenaScene = null;      // shared reference for whichever scene is active

// ═══ MODE STATE ═════════════════════════════════════════════════════════════
let currentMode = 'bridge'; // 'bridge' | 'workshop'

function toggleMode() {
  currentMode = currentMode === 'bridge' ? 'workshop' : 'bridge';
  applyMode();
}

function applyMode() {
  const tag = document.getElementById('modeTag');
  document.body.classList.remove('bridge-mode', 'workshop-mode');
  document.body.classList.add(currentMode + '-mode');

  // Morph the tag text with animation
  tag.classList.add('morphing');
  tag.textContent = currentMode === 'bridge' ? 'THE BRIDGE' : 'WORKSHOP';
  setTimeout(() => tag.classList.remove('morphing'), 400);

  // Update chat title
  document.getElementById('chatTitle').textContent = currentMode === 'bridge' ? 'Conversation' : 'Project Chat';

  // Update placeholder
  document.getElementById('chatInput').placeholder = currentMode === 'bridge' ? 'Type a message...' : 'Ask about this project...';

  // Update URL without reload
  const newPath = currentMode === 'workshop' ? '/workshop' : '/';
  history.replaceState({ mode: currentMode }, '', newPath);

  // Persist mode
  localStorage.setItem('athenaMode', currentMode);

  // Activate canvas rendering
  if (ATHENA_SCENE || OFFICE_SCENE) {
    startAthena(); // picks OfficeScene or AthenaScene based on OFFICE_SCENE flag
  } else {
    if (currentMode === 'bridge') startJarvis();
  }
}

// ═══ NAVIGATION COMPAT (kept for tests / external links) ════════════════════
// These functions exist so that old links/tests still work.
// They now just toggle mode instead of navigating to a different page.

function toggleWorkshop() {
  // Legacy compat — same as toggling mode to workshop
  if (currentMode !== 'workshop') {
    navigateToWorkshop();
  }
}

function navigateToWorkshop() {
  if (document.body.classList.contains('page-exit-active')) return;
  sessionStorage.setItem('pageTransition', 'toWorkshop');
  document.body.classList.add('page-exit-active');
  setTimeout(() => {
    document.body.classList.remove('page-exit-active');
    currentMode = 'workshop';
    applyMode();
    // Entry animation
    document.body.classList.add('page-enter-active');
    requestAnimationFrame(() => {
      requestAnimationFrame(() => {
        document.body.classList.remove('page-enter-active');
        document.body.classList.add('page-enter-ready');
        setTimeout(() => document.body.classList.remove('page-enter-ready'), 500);
      });
    });
  }, 320);
}

function navigateToBridge() {
  if (document.body.classList.contains('page-exit-active')) return;
  sessionStorage.setItem('pageTransition', 'toBridge');
  document.body.classList.add('page-exit-active');
  setTimeout(() => {
    document.body.classList.remove('page-exit-active');
    currentMode = 'bridge';
    applyMode();
    document.body.classList.add('page-enter-active');
    requestAnimationFrame(() => {
      requestAnimationFrame(() => {
        document.body.classList.remove('page-enter-active');
        document.body.classList.add('page-enter-ready');
        setTimeout(() => document.body.classList.remove('page-enter-ready'), 500);
      });
    });
  }, 320);
}

// ═══ JARVIS ORBITAL VISUALIZATION ═══════════════════════════════════════════
let jarvisRunning = false;
let jarvisRaf = null;

function startJarvis() {
  if (jarvisRunning) return;
  jarvisRunning = true;
  const canvas = document.getElementById('jarvisCanvas');
  if (!canvas) return;
  const ctx = canvas.getContext('2d');
  const dpr = window.devicePixelRatio || 1;

  function resize() {
    const rect = canvas.parentElement.getBoundingClientRect();
    canvas.width = rect.width * dpr;
    canvas.height = rect.height * dpr;
    canvas.style.width = rect.width + 'px';
    canvas.style.height = rect.height + 'px';
    ctx.scale(dpr, dpr);
  }
  resize();
  window.addEventListener('resize', resize);

  const accentRgb = [124, 166, 196]; // --accent
  const mutedRgb = [138, 136, 120];

  // Orbital rings
  const rings = [
    { r: 60, speed: 0.0004, width: 1, dash: [2, 6], opacity: 0.15 },
    { r: 95, speed: -0.0006, width: 1.2, dash: [4, 8], opacity: 0.2 },
    { r: 130, speed: 0.0003, width: 1, dash: [6, 12], opacity: 0.18 },
    { r: 170, speed: -0.0005, width: 1.5, dash: [3, 10], opacity: 0.22 },
    { r: 210, speed: 0.0002, width: 1, dash: [8, 16], opacity: 0.12 },
  ];

  // Particles on rings
  const particles = [];
  for (let i = 0; i < 8; i++) {
    const ring = rings[Math.floor(Math.random() * rings.length)];
    particles.push({
      ring,
      angle: Math.random() * Math.PI * 2,
      speed: (0.001 + Math.random() * 0.002) * (Math.random() > 0.5 ? 1 : -1),
      size: 2 + Math.random() * 2,
      pulse: Math.random() * Math.PI * 2,
    });
  }

  // Arc segments (sweeping arcs)
  const arcs = [
    { r: 140, startAngle: 0, sweep: 0.8, speed: 0.0008, width: 2, opacity: 0.25 },
    { r: 185, startAngle: Math.PI, sweep: 0.6, speed: -0.0006, width: 2.5, opacity: 0.2 },
    { r: 100, startAngle: Math.PI * 0.5, sweep: 0.5, speed: 0.001, width: 1.5, opacity: 0.18 },
  ];

  let t = 0;
  function draw() {
    if (currentMode !== 'bridge') { jarvisRunning = false; return; }
    t++;
    const w = canvas.width / dpr;
    const h = canvas.height / dpr;
    const cx = w / 2;
    const cy = h / 2;

    ctx.clearRect(0, 0, w, h);

    // Central glow
    const grad = ctx.createRadialGradient(cx, cy, 0, cx, cy, 30);
    grad.addColorStop(0, `rgba(${accentRgb.join(',')}, 0.3)`);
    grad.addColorStop(1, `rgba(${accentRgb.join(',')}, 0)`);
    ctx.beginPath();
    ctx.arc(cx, cy, 30, 0, Math.PI * 2);
    ctx.fillStyle = grad;
    ctx.fill();

    // Center dot
    ctx.beginPath();
    ctx.arc(cx, cy, 3, 0, Math.PI * 2);
    ctx.fillStyle = `rgba(${accentRgb.join(',')}, 0.8)`;
    ctx.fill();

    // Rings
    for (const ring of rings) {
      ctx.save();
      ctx.translate(cx, cy);
      ctx.rotate(t * ring.speed);
      ctx.beginPath();
      ctx.arc(0, 0, ring.r, 0, Math.PI * 2);
      ctx.strokeStyle = `rgba(${accentRgb.join(',')}, ${ring.opacity})`;
      ctx.lineWidth = ring.width;
      ctx.setLineDash(ring.dash);
      ctx.stroke();
      ctx.restore();
    }

    // Arcs
    for (const arc of arcs) {
      ctx.save();
      ctx.translate(cx, cy);
      const a = t * arc.speed + arc.startAngle;
      ctx.beginPath();
      ctx.arc(0, 0, arc.r, a, a + arc.sweep);
      ctx.strokeStyle = `rgba(${accentRgb.join(',')}, ${arc.opacity})`;
      ctx.lineWidth = arc.width;
      ctx.setLineDash([]);
      ctx.lineCap = 'round';
      ctx.stroke();
      ctx.restore();
    }

    // Particles
    for (const p of particles) {
      p.angle += p.speed;
      p.pulse += 0.03;
      const px = cx + Math.cos(p.angle) * p.ring.r;
      const py = cy + Math.sin(p.angle) * p.ring.r;
      const alpha = 0.5 + 0.5 * Math.sin(p.pulse);
      ctx.beginPath();
      ctx.arc(px, py, p.size, 0, Math.PI * 2);
      ctx.fillStyle = `rgba(${accentRgb.join(',')}, ${alpha * 0.7})`;
      ctx.fill();
    }

    jarvisRaf = requestAnimationFrame(draw);
  }
  draw();
}

function stopJarvis() {
  jarvisRunning = false;
  if (jarvisRaf) cancelAnimationFrame(jarvisRaf);
}

// ─── SCENE HELPERS ───────────────────────────────────────────────────────────
function startAthena() {
  const canvas = document.getElementById('jarvisCanvas');
  if (!canvas) return;
  if (!athenaScene) {
    // Pick the right scene class based on feature flags
    if (OFFICE_SCENE) athenaScene = new OfficeScene(canvas);
    else              athenaScene = new AthenaScene(canvas);
  }
  athenaScene.setGhostMode(currentMode === 'workshop');
  if (!athenaScene.running) athenaScene.start();
  document.body.classList.toggle('athena-scene-active', true);
  pollUsageForAthena();
}

function stopAthena() {
  if (athenaScene) athenaScene.stop();
}

async function pollUsageForAthena() {
  try {
    const r = await fetch(`${API}/usage/limits`).then(r => r.json()).catch(() => null);
    if (!r || !athenaScene) return;
    const pct = Math.max(
      (r.session_5h?.percent_used || 0),
      (r.weekly_7d?.percent_used  || 0)
    );
    athenaScene.setUsageCrit(pct >= 90);
  } catch(e) {}
}

// ═══ STATE ══════════════════════════════════════════════════════════════════
let projects = [];
let focusedId = null;
let focusedProject = null;
let runnerOnline = false;
let runnerState = {};
let devStates = {};
let gitDiffCache = {};
let healthSSE = null;
let windowIdCounter = 0;
let windows = {};
let topZ = 100;
let devUrl = null;
let apiOk = false;
let agentList = [];
let usageOpen = false;
let orchOpen = false;
let memOpen = false;

// ═══ HELPERS ═══════════════════════════════════════════════════════════════
function esc(s){ const d=document.createElement('div');d.textContent=s||'';return d.innerHTML; }
function escAttr(s){ return String(s||'').replace(/&/g,'&amp;').replace(/'/g,'&#39;').replace(/"/g,'&quot;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }
function fmt(n){ if(n==null)return'0';if(n>=1e6)return(n/1e6).toFixed(1)+'M';if(n>=1e3)return(n/1e3).toFixed(1)+'K';return String(n); }
function timeAgo(ts){ if(!ts)return'—'; const d=Date.now()-new Date(ts).getTime(); const m=Math.floor(d/60000); if(m<1)return'now'; if(m<60)return m+'m'; const h=Math.floor(m/60); if(h<24)return h+'h'; return Math.floor(h/24)+'d'; }

// ═══ CLOCK ═════════════════════════════════════════════════════════════════
function tick(){ document.getElementById('clock').textContent=new Date().toLocaleTimeString('en-US',{hour12:false}); }
setInterval(tick,1000); tick();

// ═══ API STATUS POLL ═══════════════════════════════════════════════════════
async function fetchBuildSha(){
  try{
    const r=await fetch(`${API}/version`);
    if(r.ok){
      const d=await r.json();
      const el=document.getElementById('buildSha');
      if(el && d.sha) el.textContent='#'+d.sha;
    }
  }catch(e){}
}

async function pollApiStatus(){
  const pill = document.getElementById('apiStatus');
  const bbDot = document.getElementById('bbApiDot');
  try{
    const r = await fetch(`${API}/status`);
    if(r.ok){
      apiOk = true;
      pill.className = 'status-pill ok';
      if(bbDot) bbDot.style.background = 'var(--green)';
    } else { throw new Error(); }
  }catch(e){
    apiOk = false;
    pill.className = 'status-pill off';
    if(bbDot) bbDot.style.background = 'var(--muted)';
  }
}

// ═══ ACTIVITY FEED ═════════════════════════════════════════════════════════
function addActivity(icon, text){
  const feed = document.getElementById('activityFeed');
  const t = new Date().toLocaleTimeString('en-US',{hour12:false,hour:'2-digit',minute:'2-digit'});
  const el = document.createElement('div');
  el.style.cssText='font-size:10px;padding:3px 0;color:var(--text);border-bottom:1px solid var(--border)';
  el.innerHTML=`<span style="color:var(--muted)">${t}</span> ${icon} ${esc(text)}`;
  if(feed.firstChild) feed.insertBefore(el, feed.firstChild);
  else feed.appendChild(el);
  while(feed.children.length > 30) feed.removeChild(feed.lastChild);
}

// ═══ RUNNER STATUS ═════════════════════════════════════════════════════════
async function pollRunner(){
  try{
    const r = await fetch(`${API}/runner/status`);
    runnerState = await r.json();
    runnerOnline = runnerState.online;
  }catch(e){ runnerOnline=false; runnerState={online:false}; }
  updateRunnerUI();
  updateActionButtons();
}

function updateRunnerUI(){
  const pill = document.getElementById('runnerStatus');
  const info = document.getElementById('runnerInfo');
  const bbDot = document.getElementById('bbRunnerDot');
  if(runnerOnline){
    pill.className='status-pill ok';
    info.textContent=runnerState.platform||'online';
    if(bbDot) bbDot.style.background='var(--green)';
  }else{
    pill.className='status-pill off';
    info.textContent=runnerState.last_seen?timeAgo(runnerState.last_seen):'—';
    if(bbDot) bbDot.style.background='var(--muted)';
  }
}

function updateActionButtons(){
  const on = runnerOnline && focusedId;
  ['btnLaunch','btnStage','btnCommit','btnTests','btnPushPR'].forEach(id=>{
    const el=document.getElementById(id);
    if(el) el.disabled=!on;
  });
}

// ═══ PROJECTS ══════════════════════════════════════════════════════════════
async function loadProjects(){
  try{
    const r=await fetch(`${API}/projects`);
    const data=await r.json();
    projects=data.projects||[];
    renderProjectList();
    renderHealthList();
    updateBbHealth();
    if(focusedId) refreshFocused();
  }catch(e){ console.warn('loadProjects:',e); }
}

function updateBbHealth(){
  const el=document.getElementById('bbHealth');
  if(!projects.length){ el.textContent='—'; return; }
  const up=projects.filter(p=>p.health==='up').length;
  const total=projects.length;
  if(up===total) el.innerHTML='<span style=\"color:var(--green)\">All healthy ('+total+')</span>';
  else el.innerHTML='<span style=\"color:var(--yellow)\">'+up+'/'+total+' healthy</span>';
}

function renderProjectList(){
  const el=document.getElementById('projectList');
  if(!projects.length){ el.innerHTML='<div style="padding:10px 14px;color:var(--muted);font-size:11px;font-style:italic">No projects</div>'; return; }
  el.innerHTML=projects.map(p=>{
    const active=p.id===focusedId?' active':'';
    const dot=p.health||'unknown';
    const ds=devStates[p.id];
    const devDot=ds&&ds.status==='online'?'live':'off';
    const checks=(p.checks||[]).length;
    return `<div class="proj-row${active}" onclick="focusProject('${escAttr(p.id)}')">
      <span class="dot ${dot}"></span>
      <span class="pname">${esc(p.name)}</span>
      <span class="dev-dot ${devDot}" title="${devDot==='live'?'Dev online':'Dev offline'}"></span>
      <span class="pdetail">${checks?checks+'chk':''}</span>
    </div>`;
  }).join('');
}

function renderHealthList(){
  const el=document.getElementById('healthList');
  const withChecks=projects.filter(p=>p.checks&&p.checks.length);
  if(!withChecks.length){ el.innerHTML='<div style="padding:10px;color:var(--muted);font-size:11px;font-style:italic;text-align:center">No health data</div>'; return; }
  el.innerHTML=withChecks.map(p=>{
    const active=p.id===focusedId?' active':'';
    const hClass=p.health||'unknown';
    const ds=devStates[p.id];
    const devBadge=ds?(ds.status==='online'?(ds.dirtyCount>0?`<span class="hbadge dirty">${ds.dirtyCount}Δ</span>`:'<span class="hbadge dev-on">DEV ✓</span>'):'<span class="hbadge dev-off">DEV —</span>'):'';
    const branch=ds&&ds.branch?ds.branch:'main';
    const latest=(p.checks||[])[0]||{};
    const ago=latest.timestamp?timeAgo(latest.timestamp):'—';
    return `<div class="hcard${active}" onclick="focusProject('${escAttr(p.id)}')">
      <div class="hcard-top">
        <div class="hcard-name"><span class="dot ${hClass}"></span> ${esc(p.name)}</div>
        <div class="hcard-badges"><span class="hbadge ${hClass}">${(p.health||'?').toUpperCase()}</span>${devBadge}</div>
      </div>
      <div class="hcard-row"><span class="branch">${esc(branch)}</span><span class="time">${ago}</span></div>
      <div class="hcard-actions">
        <button class="hcard-btn" onclick="event.stopPropagation();runHealthCheck('${escAttr(p.id)}')" title="Run health check now">&#10003; Check</button>
        <button class="hcard-btn" onclick="event.stopPropagation();showIncidents('${escAttr(p.id)}')" title="View incidents">&#9888; Incidents</button>
      </div>
    </div>`;
  }).join('');
}

async function runHealthCheck(projectId){
  try{
    const r=await fetch(`${API}/projects/${encodeURIComponent(projectId)}/check`,{method:'POST'});
    if(r.ok){
      addActivity('🔄',`Health check triggered: ${projectId}`);
    } else {
      addActivity('❌',`Health check failed: ${projectId}`);
    }
  }catch(e){ addActivity('❌','Health check error: '+e.message); }
}

// ═══ FOCUS PROJECT ═════════════════════════════════════════════════════════
async function focusProject(id){
  focusedId=id;
  focusedProject=projects.find(p=>p.id===id)||null;
  devUrl=null;
  renderProjectList();
  renderHealthList();
  updateActionButtons();
  updateCenterHeader();
  await fetchDevState(id);
  updateCenterHeader();
  await fetchGitDiff(id);
  renderFileTree();
  updateChatCtx();
  document.getElementById('bbFocused').textContent=focusedProject?focusedProject.name:'—';
  addActivity('📂', `Focused: ${focusedProject?focusedProject.name:id}`);
}

async function refreshFocused(){
  if(!focusedId) return;
  await fetchDevState(focusedId);
  updateCenterHeader();
  await fetchGitDiff(focusedId);
  renderFileTree();
  updateChatCtx();
}

function updateCenterHeader(){
  const hdr=document.getElementById('centerHeader');
  if(!focusedProject){ hdr.innerHTML='<span class="proj-label">No project selected</span>'; return; }
  const ds=devStates[focusedId];
  let parts=`<span class="proj-label">${esc(focusedProject.name)}</span>`;
  if(ds&&ds.status==='online'){
    parts+=`<span class="branch-tag">⎇ ${esc(ds.branch||'?')}</span>`;
    if(ds.dirtyCount>0) parts+=`<span class="dirty-tag">${ds.dirtyCount} dirty</span>`;
    else parts+=`<span style="color:var(--green);font-size:10px">✓ clean</span>`;
    if(ds.lastCommit){
      const commitText=typeof ds.lastCommit==='string'?ds.lastCommit:(ds.lastCommit.message||ds.lastCommit.sha||'');
      if(commitText) parts+=`<span style="color:var(--muted);font-size:10px;max-width:200px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${esc(commitText.substring(0,40))}</span>`;
    }
  }else if(runnerOnline){
    parts+=`<span style="color:var(--muted);font-size:10px">no local path</span>`;
  }else{
    parts+=`<span style="color:var(--muted);font-size:10px">runner offline</span>`;
  }
  if(devUrl) parts+=`<a class="dev-url" href="${esc(devUrl)}" target="_blank">Dev: ${esc(devUrl)}</a>`;
  parts+=`<button class="ch-btn" onclick="openDiffWindow()" ${runnerOnline&&focusedId?'':'disabled'}>View All Changes</button>`;
  hdr.innerHTML=parts;
}

function updateChatCtx(){
  const el=document.getElementById('chatCtx');
  if(!focusedProject){ el.innerHTML='Select a project to begin'; return; }
  const ds=devStates[focusedId];
  let html=`<span>${esc(focusedProject.name)}</span>`;
  if(ds&&ds.status==='online'){
    html+=` · <span class="ctx-branch">⎇ ${esc(ds.branch||'?')}</span>`;
    if(ds.dirtyCount>0) html+=` · <span style="color:var(--yellow)">${ds.dirtyCount} dirty</span>`;
  }
  if(devUrl) html+=` · <span class="ctx-url">${esc(devUrl)}</span>`;
  el.innerHTML=html;
}

// ═══ DEV STATE ═════════════════════════════════════════════════════════════
async function fetchDevState(id){
  if(!runnerOnline){ devStates[id]={status:'offline'}; return; }
  try{
    const r=await fetch(`${API}/runner/dev-state/${id}`);
    devStates[id]=await r.json();
  }catch(e){ devStates[id]={status:'offline'}; }
}

async function fetchAllDevStates(){
  if(!runnerOnline)return;
  for(const p of projects){
    try{ const r=await fetch(`${API}/runner/dev-state/${p.id}`); devStates[p.id]=await r.json(); }
    catch(e){ devStates[p.id]={status:'offline'}; }
  }
  renderProjectList();
  renderHealthList();
  if(focusedId){ updateCenterHeader(); updateChatCtx(); }
}

// ═══ GIT DIFF ══════════════════════════════════════════════════════════════
async function fetchGitDiff(id){
  if(!runnerOnline){ gitDiffCache[id]=''; return; }
  try{
    const r=await fetch(`${API}/runner/git/diff?projectId=${id}`);
    if(r.ok){ const d=await r.json(); gitDiffCache[id]=d.diff||''; }
    else gitDiffCache[id]='';
  }catch(e){ gitDiffCache[id]=''; }
}

// ═══ FILE TREE (CHANGED FILES ONLY) ═══════════════════════════════════════
function renderFileTree(){
  const container=document.getElementById('fileTree');
  const countEl=document.getElementById('ftCount');
  const ds=devStates[focusedId];
  if(!focusedId||!ds||ds.status!=='online'||!ds.changedFiles||!ds.changedFiles.length){
    container.innerHTML='<div class="ft-empty">'+(focusedId?(runnerOnline?'No changes':'Runner offline'):'Select a project')+'</div>';
    countEl.textContent='0';
    return;
  }
  const files=ds.changedFiles;
  countEl.textContent=files.length;

  const parsed=files.map(f=>{
    let status='M', path=f;
    const m=f.match(/^([MADRCU?!]{1,2})\s+(.+)$/);
    if(m){ status=m[1].trim(); path=m[2]; }
    const parts=path.split('/');
    const name=parts.pop();
    const dir=parts.join('/')||'.';
    return {status:status[0],path,dir,name};
  });

  const groups={};
  parsed.forEach(f=>{ (groups[f.dir]=groups[f.dir]||[]).push(f); });
  const sortedDirs=Object.keys(groups).sort();

  let html='';
  for(const dir of sortedDirs){
    html+=`<div class="ft-dir">📁 ${esc(dir)}</div>`;
    for(const f of groups[dir]){
      const icon=f.status==='A'?'🟢':f.status==='D'?'🔴':f.status==='?'?'🟡':'📝';
      html+=`<div class="ft-file" data-filepath="${escAttr(f.path)}" title="${escAttr(f.path)}">
        <span class="ficon">${icon}</span>
        <span class="fname">${esc(f.name)}</span>
        <span class="fstat ${f.status}">${f.status}</span>
      </div>`;
    }
  }
  container.innerHTML=html;
  container.querySelectorAll('.ft-file[data-filepath]').forEach(el=>{
    el.addEventListener('click',()=>openFileDiff(el.dataset.filepath));
  });
}

// ═══ FLOATING WINDOW MANAGER ══════════════════════════════════════════════
function createWindow(type, title, content, opts={}){
  const id = ++windowIdCounter;
  const area = document.getElementById('winArea');
  const emptyEl = document.getElementById('winEmpty');
  if(emptyEl) emptyEl.style.display='none';

  // Auto-switch to workshop if in bridge mode
  if(currentMode === 'bridge'){
    currentMode = 'workshop';
    applyMode();
  }

  topZ++;
  const w = opts.width || 600;
  const h = opts.height || 400;
  const offset = (Object.keys(windows).length % 6) * 30;
  const x = 20 + offset;
  const y = 20 + offset;

  const win = document.createElement('div');
  win.className = 'float-win focused';
  win.style.cssText = `left:${x}px;top:${y}px;width:${w}px;height:${h}px;z-index:${topZ}`;
  win.dataset.winId = id;
  win.innerHTML = `
    <div class="fw-titlebar" onmousedown="startDrag(event,${id})">
      <span class="fw-icon">${type==='diff'?'📄':type==='term'?'💻':'📝'}</span>
      <span class="fw-title">${esc(title)}</span>
      <button class="fw-close" onclick="closeWindow(${id})">&times;</button>
    </div>
    <div class="fw-body">${content}</div>`;
  win.addEventListener('mousedown',()=>bringToFront(id));
  area.appendChild(win);

  const resizer = document.createElement('div');
  resizer.style.cssText='position:absolute;right:0;bottom:0;width:14px;height:14px;cursor:nwse-resize';
  resizer.addEventListener('mousedown',e=>startResize(e,id));
  win.appendChild(resizer);

  Object.values(windows).forEach(w=>w.el.classList.remove('focused'));
  win.classList.add('focused');

  windows[id]={el:win,type,title,z:topZ};
  return id;
}

function closeWindow(id){
  const w=windows[id];
  if(!w)return;
  w.el.remove();
  delete windows[id];
  if(!Object.keys(windows).length){
    const emptyEl=document.getElementById('winEmpty');
    if(emptyEl) emptyEl.style.display='';
  }
}

function bringToFront(id){
  topZ++;
  Object.values(windows).forEach(w=>{w.el.classList.remove('focused');w.el.classList.add('unfocused')});
  const w=windows[id];
  if(w){w.el.style.zIndex=topZ;w.z=topZ;w.el.classList.add('focused');w.el.classList.remove('unfocused');}
}

// ── Drag ────────────────────────────────────────────────────────────────
let dragState=null;
function startDrag(e,id){
  if(e.target.closest('.fw-close'))return;
  const w=windows[id]; if(!w)return;
  bringToFront(id);
  const rect=w.el.getBoundingClientRect();
  dragState={id,offX:e.clientX-rect.left,offY:e.clientY-rect.top};
  e.preventDefault();
}
document.addEventListener('mousemove',e=>{
  if(!dragState)return;
  const w=windows[dragState.id]; if(!w)return;
  const area=document.getElementById('winArea').getBoundingClientRect();
  let x=e.clientX-area.left-dragState.offX;
  let y=e.clientY-area.top-dragState.offY;
  x=Math.max(0,Math.min(x,area.width-100));
  y=Math.max(0,Math.min(y,area.height-32));
  w.el.style.left=x+'px';
  w.el.style.top=y+'px';
});
document.addEventListener('mouseup',()=>{ dragState=null; resizeState=null; });

// ── Resize ──────────────────────────────────────────────────────────────
let resizeState=null;
function startResize(e,id){
  const w=windows[id]; if(!w)return;
  bringToFront(id);
  const rect=w.el.getBoundingClientRect();
  resizeState={id,startW:rect.width,startH:rect.height,startX:e.clientX,startY:e.clientY};
  e.preventDefault();e.stopPropagation();
}
document.addEventListener('mousemove',e=>{
  if(!resizeState)return;
  const w=windows[resizeState.id]; if(!w)return;
  const dw=e.clientX-resizeState.startX;
  const dh=e.clientY-resizeState.startY;
  w.el.style.width=Math.max(300,resizeState.startW+dw)+'px';
  w.el.style.height=Math.max(200,resizeState.startH+dh)+'px';
});

// ═══ DIFF VIEWER ═══════════════════════════════════════════════════════════
function renderDiffHtml(diffText, filterPath){
  if(!diffText) return '<div style="padding:20px;color:var(--muted);font-style:italic">No diff available</div>';
  const lines=diffText.split('\n');
  let html='';
  let inFile=false;
  let currentFile='';

  for(const line of lines){
    if(line.startsWith('diff --git')){
      const m=line.match(/b\/(.+)$/);
      currentFile=m?m[1]:'';
      if(filterPath && currentFile!==filterPath){ inFile=false; continue; }
      inFile=true;
      html+=`<div class="diff-file-header">${esc(currentFile)}</div>`;
      continue;
    }
    if(!inFile && filterPath)continue;
    if(line.startsWith('---')||line.startsWith('+++')){
      if(!filterPath) inFile=true;
      continue;
    }
    if(line.startsWith('@@')){
      html+=`<div class="diff-hunk">${esc(line)}</div>`;
      continue;
    }
    if(!inFile && !filterPath) continue;
    if(line.startsWith('+')){
      html+=`<div class="diff-line add">${esc(line)}</div>`;
    }else if(line.startsWith('-')){
      html+=`<div class="diff-line del">${esc(line)}</div>`;
    }else{
      html+=`<div class="diff-line ctx">${esc(line)}</div>`;
    }
  }
  if(!html) return '<div style="padding:20px;color:var(--muted);font-style:italic">'+(filterPath?'No changes for this file':'No diff available')+'</div>';
  return `<div class="diff-view">${html}</div>`;
}

function openFileDiff(path){
  const diff=gitDiffCache[focusedId]||'';
  const html=renderDiffHtml(diff,path);
  createWindow('diff', path, html, {width:650,height:450});
  addActivity('📄', `Opened diff: ${path}`);
}

function openDiffWindow(){
  if(!focusedId)return;
  const diff=gitDiffCache[focusedId]||'';
  const html=renderDiffHtml(diff,null);
  createWindow('diff', 'All Changes', html, {width:700,height:500});
  addActivity('📄', 'Opened full diff view');
}

// ═══ TERMINAL WINDOW ══════════════════════════════════════════════════════
function openTermWindow(title, content, isError){
  const cls=isError?'term-view error':'term-view';
  const html=`<div class="${cls}">${esc(content)}</div>`;
  const wid=createWindow('term', title, html, {width:600,height:350});
  return wid;
}

function updateTermWindow(wid, content, isError){
  const w=windows[wid];
  if(!w)return;
  const body=w.el.querySelector('.fw-body');
  const cls=isError?'term-view error':'term-view';
  body.innerHTML=`<div class="${cls}">${esc(content)}</div>`;
  body.scrollTop=body.scrollHeight;
}

// ═══ COMMIT WINDOW ═══════════════════════════════════════════════════════
function openCommitWindow(title, description, files){
  const fileListHtml=files.map(f=>`<div>${esc(f)}</div>`).join('');
  const html=`<div class="commit-view">
    <label>Commit Title</label>
    <input id="commitTitle" value="${esc(title)}">
    <label>Description</label>
    <textarea id="commitDesc">${esc(description)}</textarea>
    <label>Files to commit</label>
    <div class="file-list">${fileListHtml||'<span style="color:var(--muted)">No files</span>'}</div>
    <div class="cv-actions">
      <button class="cv-btn outline" onclick="closeAllCommitWindows()">Cancel</button>
      <button class="cv-btn primary" id="commitConfirmBtn" onclick="confirmCommit()">Commit</button>
      <button class="cv-btn primary" style="background:var(--green)" onclick="confirmCommitAndPR()">Commit &amp; PR</button>
    </div>
  </div>`;
  createWindow('commit', '📝 Commit', html, {width:500,height:450});
}

function closeAllCommitWindows(){
  Object.entries(windows).forEach(([id,w])=>{ if(w.type==='commit') closeWindow(Number(id)); });
}

// ═══ CHAT ═══════════════════════════════════════════════════════════════
function clearChat(){ document.getElementById('chatMessages').innerHTML=''; }

async function sendChat(){
  const input=document.getElementById('chatInput');
  const message=input.value.trim();
  if(!message)return;
  input.value='';
  const agent=document.getElementById('agentSelect').value;
  const container=document.getElementById('chatMessages');
  const t=new Date().toLocaleTimeString('en-US',{hour12:false,hour:'2-digit',minute:'2-digit'});
  container.innerHTML+=`<div class="msg user">${esc(message)}<div class="msg-time">${t}</div></div>`;
  const pendingId='msg-'+Date.now();
  container.innerHTML+=`<div class="msg assistant streaming" id="${pendingId}">Thinking...</div>`;
  container.scrollTop=container.scrollHeight;

  const ctx=focusedProject?`Project: ${focusedProject.name}`:'';

  try{
    const response = await fetch(`${API}/chat/stream`,{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({agent,message,task_context:ctx})
    });

    if(!response.ok){
      return sendChatSync(message, agent, ctx, pendingId);
    }

    const reader = response.body.getReader();
    const decoder = new TextDecoder();
    let buffer = '';
    let fullText = '';
    const pending = document.getElementById(pendingId);
    if(pending) pending.innerHTML = '';

    while(true){
      const {done, value} = await reader.read();
      if(done) break;
      buffer += decoder.decode(value, {stream: true});

      const lines = buffer.split('\n');
      buffer = lines.pop() || '';

      let eventType = '';
      for(const line of lines){
        if(line.startsWith('event: ')){
          eventType = line.substring(7).trim();
        } else if(line.startsWith('data: ')){
          const data = line.substring(6);
          try{
            const parsed = JSON.parse(data);
            if(eventType === 'chunk'){
              fullText += parsed.text || '';
              if(pending) pending.innerHTML = esc(fullText);
              container.scrollTop = container.scrollHeight;
            } else if(eventType === 'done'){
              fullText = parsed.response || fullText;
              if(pending){
                const rt = new Date().toLocaleTimeString('en-US',{hour12:false,hour:'2-digit',minute:'2-digit'});
                pending.innerHTML = `${esc(fullText)}<div class="msg-time">${rt}</div>`;
                pending.classList.remove('streaming');
              }
            } else if(eventType === 'error'){
              if(pending){
                pending.innerHTML = `<span style="color:var(--red)">Error: ${esc(parsed.detail||'Unknown')}</span>`;
                pending.classList.remove('streaming');
              }
            }
          }catch(e){}
        }
      }
    }

    if(pending && pending.classList.contains('streaming')){
      const rt = new Date().toLocaleTimeString('en-US',{hour12:false,hour:'2-digit',minute:'2-digit'});
      pending.innerHTML = `${esc(fullText||'(empty response)')}<div class="msg-time">${rt}</div>`;
      pending.classList.remove('streaming');
    }

  }catch(e){
    return sendChatSync(message, agent, ctx, pendingId);
  }
}

async function sendChatSync(message, agent, ctx, pendingId){
  try{
    const r=await fetch(`${API}/chat`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({agent,message,task_context:ctx})});
    const pending=document.getElementById(pendingId);
    if(!r.ok){
      const err=await r.json();
      if(pending){pending.innerHTML=`<span style="color:var(--red)">Error: ${esc(err.detail||r.statusText)}</span>`;pending.classList.remove('streaming');}
      return;
    }
    const data=await r.json();
    const rt=new Date().toLocaleTimeString('en-US',{hour12:false,hour:'2-digit',minute:'2-digit'});
    if(pending){pending.innerHTML=`${esc(data.response)}<div class="msg-time">${rt}</div>`;pending.classList.remove('streaming');}
    document.getElementById('chatMessages').scrollTop=document.getElementById('chatMessages').scrollHeight;
  }catch(e){
    const p=document.getElementById(pendingId);
    if(p){p.innerHTML='<span style="color:var(--red)">Request failed</span>';p.classList.remove('streaming');}
  }
}

// ═══ ACTION BUTTONS ═══════════════════════════════════════════════════════
async function runRunnerCmd(projectId, command, timeoutSec=120){
  const r=await fetch(`${API}/runner/cmd`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({projectId,command,timeoutSec})});
  if(!r.ok){ const e=await r.json(); throw new Error(e.detail||r.statusText); }
  return r.json();
}

async function runRunnerCmdStream(projectId, command, wid, timeoutSec=120){
  try{
    const response = await fetch(`${API}/runner/cmd/stream`,{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({projectId,command,timeoutSec})
    });
    if(!response.ok){
      const result = await runRunnerCmd(projectId, command, timeoutSec);
      const output = (result.stdout||'')+(result.stderr?'\n'+result.stderr:'');
      updateTermWindow(wid, output, result.exitCode!==0);
      return result;
    }

    const reader = response.body.getReader();
    const decoder = new TextDecoder();
    let buffer = '';
    let finalResult = null;

    while(true){
      const {done, value} = await reader.read();
      if(done) break;
      buffer += decoder.decode(value, {stream: true});

      const lines = buffer.split('\n');
      buffer = lines.pop() || '';

      let eventType = '';
      for(const line of lines){
        if(line.startsWith('event: ')){
          eventType = line.substring(7).trim();
        } else if(line.startsWith('data: ')){
          try{
            const parsed = JSON.parse(line.substring(6));
            if(eventType === 'running'){
              updateTermWindow(wid, `⏳ Running... (${parsed.elapsed}s)`, false);
            } else if(eventType === 'output'){
              finalResult = parsed;
              const output = (parsed.stdout||'')+(parsed.stderr?'\n'+parsed.stderr:'');
              updateTermWindow(wid, output, parsed.exitCode!==0);
            } else if(eventType === 'error'){
              updateTermWindow(wid, '❌ '+parsed.detail, true);
              throw new Error(parsed.detail);
            }
          }catch(e){ if(e.message && !e.message.includes('JSON')) throw e; }
        }
      }
    }
    return finalResult;
  }catch(e){
    if(!e.message?.includes('Runner')){
      const result = await runRunnerCmd(projectId, command, timeoutSec);
      const output = (result.stdout||'')+(result.stderr?'\n'+result.stderr:'');
      updateTermWindow(wid, output, result.exitCode!==0);
      return result;
    }
    throw e;
  }
}

async function launchDev(){
  if(!focusedId||!runnerOnline)return;
  const btn=document.getElementById('btnLaunch');
  btn.classList.add('running');btn.disabled=true;
  addActivity('▶️','Launching dev server...');
  const wid=openTermWindow(`Dev: ${focusedProject?.name||focusedId}`,'⏳ Starting dev server...\n',false);
  try{
    const result=await runRunnerCmdStream(focusedId,'dev',wid,30);
    if(result){
      const output=(result.stdout||'')+(result.stderr?'\n'+result.stderr:'');
      addActivity(result.exitCode===0?'✅':'❌',`Dev server ${result.exitCode===0?'started':'failed'}`);
      const urlMatch=output.match(/https?:\/\/localhost:\d+/);
      if(urlMatch){
        devUrl=urlMatch[0];
        updateCenterHeader();
        updateChatCtx();
        addActivity('🔗',`Dev URL: ${devUrl}`);
      }
    }
  }catch(e){
    updateTermWindow(wid,'Error: '+e.message,true);
    addActivity('❌','Launch failed: '+e.message);
  }finally{ btn.classList.remove('running');btn.disabled=!runnerOnline||!focusedId; }
}

async function runTests(){
  if(!focusedId||!runnerOnline)return;
  const btn=document.getElementById('btnTests');
  btn.classList.add('running');btn.disabled=true;
  addActivity('🧪','Running tests...');
  const wid=openTermWindow(`Tests: ${focusedProject?.name||focusedId}`,'⏳ Running tests...\n',false);
  try{
    const result=await runRunnerCmdStream(focusedId,'test',wid,300);
    if(result){
      addActivity(result.exitCode===0?'✅':'❌',`Tests ${result.exitCode===0?'passed':'failed'}`);
    }
  }catch(e){
    updateTermWindow(wid,'Error: '+e.message,true);
    addActivity('❌','Tests failed: '+e.message);
  }finally{ btn.classList.remove('running');btn.disabled=!runnerOnline||!focusedId; }
}

async function stageFiles(){
  if(!focusedId||!runnerOnline)return;
  const btn=document.getElementById('btnStage');
  btn.classList.add('running');btn.disabled=true;
  addActivity('➕','Staging files...');
  try{
    await runRunnerCmd(focusedId,'git add -A',30);
    addActivity('✅','All files staged');
    await fetchDevState(focusedId);
    renderFileTree();
    updateCenterHeader();
  }catch(e){
    addActivity('❌','Stage failed: '+e.message);
  }finally{ btn.classList.remove('running');btn.disabled=!runnerOnline||!focusedId; }
}

async function generateCommit(){
  if(!focusedId||!runnerOnline)return;
  const btn=document.getElementById('btnCommit');
  btn.classList.add('running');btn.disabled=true;
  addActivity('📝','Generating commit message...');

  try{
    await runRunnerCmd(focusedId,'git add -A',30);
    const diffR=await fetch(`${API}/runner/git/diff?projectId=${focusedId}`);
    const diffData=await diffR.json();
    const diff=(diffData.diff||'').substring(0,8000);
    const ds=devStates[focusedId];
    const files=(ds&&ds.changedFiles)||[];

    const prompt=`You are writing a git commit message. Based on this diff, write a concise commit title (max 72 chars, conventional commits format like "feat: ...", "fix: ...", "refactor: ...") and a short description (2-3 sentences). Reply in exactly this JSON format: {"title":"...","description":"..."}

Diff:
${diff}`;

    const r=await fetch(`${API}/runner/claude/run`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({projectId:focusedId,prompt,timeoutSec:120})});
    if(!r.ok){ const e=await r.json(); throw new Error(e.detail||r.statusText); }
    const result=await r.json();
    const output=(result.stdout||'').trim();

    let title='', description='';
    try{
      const jsonMatch=output.match(/\{[\s\S]*\}/);
      if(jsonMatch){
        const parsed=JSON.parse(jsonMatch[0]);
        title=parsed.title||'';
        description=parsed.description||'';
      }
    }catch(e){}
    if(!title) title=output.substring(0,72);
    if(!description) description=output;

    openCommitWindow(title, description, files);
    addActivity('📝','Commit message generated');
  }catch(e){
    addActivity('❌','Generate commit failed: '+e.message);
    alert('Failed to generate commit: '+e.message);
  }finally{ btn.classList.remove('running');btn.disabled=!runnerOnline||!focusedId; }
}

async function confirmCommit(){
  const titleEl=document.getElementById('commitTitle');
  const descEl=document.getElementById('commitDesc');
  const confirmBtn=document.getElementById('commitConfirmBtn');
  if(!titleEl||!descEl)return;
  const title=titleEl.value.trim();
  const desc=descEl.value.trim();
  if(!title){ alert('Commit title is required'); return; }
  confirmBtn.disabled=true;
  confirmBtn.textContent='Committing...';

  const message=desc?`${title}\n\n${desc}`:title;
  try{
    const safe=message.replace(/"/g,'\\"').replace(/`/g,'\\`');
    await runRunnerCmd(focusedId,`git commit -m "${safe}"`,30);
    addActivity('✅',`Committed: ${title}`);
    closeAllCommitWindows();
    await refreshFocused();
    renderProjectList();
    renderHealthList();
  }catch(e){
    addActivity('❌','Commit failed: '+e.message);
    alert('Commit failed: '+e.message);
    confirmBtn.disabled=false;
    confirmBtn.textContent='Commit';
  }
}

// ═══ HEALTH SSE ═══════════════════════════════════════════════════════════
function connectHealthSSE(){
  if(healthSSE) healthSSE.close();
  healthSSE=new EventSource(`${API}/health/stream`);
  healthSSE.addEventListener('init',e=>{
    try{
      const data=JSON.parse(e.data);
      if(data && typeof data==='object'){
        const projectIds=Object.keys(data);
        const checkCount=projectIds.reduce((sum,pid)=>(data[pid]||[]).length+sum,0);
        addActivity('❤️',`Health init: ${checkCount} check(s) across ${projectIds.length} project(s)`);
        loadProjects();
      }
    }catch(err){ console.warn('Health SSE init parse error:',err); }
  });
  healthSSE.addEventListener('check',e=>{
    try{
      const data=JSON.parse(e.data);
      addActivity(data.status==='up'?'🟢':(data.status==='down'?'🔴':'🟡'),`${data.project_id}/${data.check_id}: ${data.status}`);
      loadProjects();
      // Athena: map health status to tester sprite warning (tester owns health checks)
      if(ATHENA_SCENE && athenaScene){
        athenaScene.setAgentWarning('tester', data.status==='up' ? null : data.status);
      }
    }catch(err){}
  });
  healthSSE.onerror=()=>{ setTimeout(connectHealthSSE,5000); };
}

// ═══ TASK BOARD ═══════════════════════════════════════════════════════════
let boardOpen = false;
const COLUMNS = ['backlog','planned','in-progress','review','done'];
const COL_ICONS = {backlog:'📥',planned:'📋','in-progress':'⚡',review:'🔍',done:'✅'};
let newTaskColumn = null;

function toggleTaskBoard(){
  boardOpen = !boardOpen;
  const overlay = document.getElementById('boardOverlay');
  const btn = document.getElementById('tbBoard');
  if(boardOpen){
    overlay.classList.add('open');
    btn.classList.add('active');
    loadBoard();
    updateBoardProjectFilter();
  }else{
    overlay.classList.remove('open');
    btn.classList.remove('active');
  }
}

function updateBoardProjectFilter(){
  const sel = document.getElementById('boardProjectFilter');
  const current = sel.value;
  sel.innerHTML = '<option value="">All projects</option>';
  projects.forEach(p=>{
    sel.innerHTML += `<option value="${p.id}" ${p.id===current?'selected':''}>${esc(p.name)}</option>`;
  });
}

async function loadBoard(){
  const filter = document.getElementById('boardProjectFilter')?.value || '';
  const url = filter ? `${API}/tasks/board?project_id=${filter}` : `${API}/tasks/board`;
  try{
    const r = await fetch(url);
    const data = await r.json();
    renderBoard(data.board, data.stats);
  }catch(e){
    console.warn('loadBoard:', e);
    renderEmptyBoard();
  }
}

function renderEmptyBoard(){
  const body = document.getElementById('boardBody');
  body.innerHTML = COLUMNS.map(col=>{
    const label = col.replace('-',' ');
    return `<div class="board-col">
      <div class="board-col-header ${col}">${COL_ICONS[col]||''} ${label} <span class="col-count">0</span></div>
      <div class="board-col-body"></div>
      <div class="board-col-add"><button onclick="showNewTaskForm('${col}')">+ Add task</button></div>
    </div>`;
  }).join('');
}

function renderBoard(board, stats){
  const body = document.getElementById('boardBody');
  body.innerHTML = COLUMNS.map(col=>{
    const tasks = board[col] || [];
    const label = col.replace('-',' ');
    const count = tasks.length;
    const cardsHtml = tasks.map(t => renderTaskCard(t, col)).join('');

    return `<div class="board-col">
      <div class="board-col-header ${col}">${COL_ICONS[col]||''} ${label} <span class="col-count">${count}</span></div>
      <div class="board-col-body" id="colBody-${col}">${cardsHtml}</div>
      <div class="board-col-add"><button onclick="showNewTaskForm('${col}')">+ Add task</button></div>
    </div>`;
  }).join('');
}

function renderTaskCard(t, col){
  const priorityIcon = t.priority>=2?'<span class="tc-priority urgent">🔴</span>':
                       t.priority>=1?'<span class="tc-priority high">🟠</span>':'';
  const agentBadge = t.agent?`<span class="tc-agent">${esc(t.agent)}</span>`:'';
  const projectBadge = t.project_id?`<span class="tc-project">${esc(t.project_id)}</span>`:'';
  const autopilotBadge = t.autopilot?'<span class="tc-autopilot">⚡ Auto</span>':'';
  const descSnippet = t.description?`<div style="font-size:10px;color:var(--muted);margin:2px 0;max-height:30px;overflow:hidden">${esc(t.description.substring(0,80))}</div>`:'';

  const colIdx = COLUMNS.indexOf(col);
  const leftBtn = colIdx>0?`<button class="tc-act" onclick="event.stopPropagation();moveTask('${t.id}','${COLUMNS[colIdx-1]}')">◀</button>`:'';
  const rightBtn = colIdx<COLUMNS.length-1?`<button class="tc-act" onclick="event.stopPropagation();moveTask('${t.id}','${COLUMNS[colIdx+1]}')">▶</button>`:'';
  const delBtn = `<button class="tc-act del" onclick="event.stopPropagation();deleteTask('${t.id}')">✕</button>`;

  return `<div class="task-card" onclick="editTask('${t.id}')">
    <div class="tc-title">${priorityIcon}${esc(t.title)}</div>
    ${descSnippet}
    <div class="tc-meta">${agentBadge}${projectBadge}${autopilotBadge}</div>
    <div class="tc-actions">${leftBtn}${rightBtn}${delBtn}</div>
  </div>`;
}

function showNewTaskForm(col){
  newTaskColumn = col;
  const colBody = document.getElementById(`colBody-${col}`);
  if(!colBody) return;
  document.querySelectorAll('.new-task-form').forEach(el=>el.remove());

  const form = document.createElement('div');
  form.className='new-task-form';
  form.innerHTML=`
    <input id="ntfTitle" placeholder="Task title...">
    <textarea id="ntfDesc" placeholder="Description (optional)"></textarea>
    <div class="ntf-row">
      <select id="ntfAgent">
        <option value="">No agent</option>
        <option value="manager">Manager</option>
        <option value="frontend">Frontend</option>
        <option value="backend">Backend</option>
        <option value="tester">Tester</option>
      </select>
      <select id="ntfPriority">
        <option value="0">Normal</option>
        <option value="1">High</option>
        <option value="2">Urgent</option>
      </select>
    </div>
    <div class="ntf-row">
      <select id="ntfProject">
        <option value="">No project</option>
        ${projects.map(p=>`<option value="${p.id}" ${p.id===focusedId?'selected':''}>${esc(p.name)}</option>`).join('')}
      </select>
      <label style="display:flex;align-items:center;gap:4px;font-size:10px;color:var(--muted);cursor:pointer">
        <input type="checkbox" id="ntfAutopilot"> Autopilot
      </label>
    </div>
    <div class="ntf-actions">
      <button class="ntf-btn cancel" onclick="this.closest('.new-task-form').remove()">Cancel</button>
      <button class="ntf-btn save" onclick="submitNewTask()">Create</button>
    </div>`;
  colBody.appendChild(form);
  document.getElementById('ntfTitle').focus();
}

async function submitNewTask(){
  const title = document.getElementById('ntfTitle')?.value.trim();
  if(!title){ alert('Title is required'); return; }
  const body = {
    title,
    description: document.getElementById('ntfDesc')?.value.trim()||'',
    column: newTaskColumn||'backlog',
    agent: document.getElementById('ntfAgent')?.value||null,
    priority: parseInt(document.getElementById('ntfPriority')?.value||'0'),
    project_id: document.getElementById('ntfProject')?.value||null,
    autopilot: document.getElementById('ntfAutopilot')?.checked||false,
  };
  try{
    await fetch(`${API}/tasks/`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(body)});
    addActivity('📋',`Task created: ${title}`);
    loadBoard();
  }catch(e){ alert('Failed to create task: '+e.message); }
}

async function moveTask(taskId, toColumn){
  try{
    await fetch(`${API}/tasks/${taskId}/move`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({column:toColumn})});
    loadBoard();
  }catch(e){ console.warn('moveTask:', e); }
}

async function deleteTask(taskId){
  if(!confirm('Delete this task?')) return;
  try{
    await fetch(`${API}/tasks/${taskId}`,{method:'DELETE'});
    addActivity('🗑️','Task deleted');
    loadBoard();
  }catch(e){ console.warn('deleteTask:', e); }
}

async function editTask(taskId){
  try{
    const r = await fetch(`${API}/tasks/${taskId}`);
    const data = await r.json();
    const t = data.task;
    const html = `<div class="commit-view">
      <label>Title</label>
      <input id="editTitle-${taskId}" value="${esc(t.title)}">
      <label>Description</label>
      <textarea id="editDesc-${taskId}">${esc(t.description)}</textarea>
      <div class="ntf-row" style="margin-bottom:12px">
        <div style="flex:1"><label>Agent</label>
        <select id="editAgent-${taskId}" style="width:100%;background:var(--bg);border:1px solid var(--border);color:var(--text);padding:5px;border-radius:4px;font-size:11px">
          <option value="">None</option>
          <option value="manager" ${t.agent==='manager'?'selected':''}>Manager</option>
          <option value="frontend" ${t.agent==='frontend'?'selected':''}>Frontend</option>
          <option value="backend" ${t.agent==='backend'?'selected':''}>Backend</option>
          <option value="tester" ${t.agent==='tester'?'selected':''}>Tester</option>
        </select></div>
        <div style="flex:1"><label>Priority</label>
        <select id="editPriority-${taskId}" style="width:100%;background:var(--bg);border:1px solid var(--border);color:var(--text);padding:5px;border-radius:4px;font-size:11px">
          <option value="0" ${t.priority===0?'selected':''}>Normal</option>
          <option value="1" ${t.priority===1?'selected':''}>High</option>
          <option value="2" ${t.priority>=2?'selected':''}>Urgent</option>
        </select></div>
      </div>
      <div style="display:flex;align-items:center;gap:8px;margin-bottom:12px">
        <label style="font-size:10px;color:var(--muted);display:flex;align-items:center;gap:4px;cursor:pointer">
          <input type="checkbox" id="editAP-${taskId}" ${t.autopilot?'checked':''}> Autopilot
        </label>
      </div>
      ${t.result?`<label>Result</label><div style="font-family:var(--font-mono);font-size:10px;background:var(--bg);border:1px solid var(--border);border-radius:4px;padding:8px;margin-bottom:12px;max-height:100px;overflow-y:auto">${esc(t.result)}</div>`:''}
      <div class="cv-actions">
        <button class="cv-btn outline" onclick="closeWindow(${windowIdCounter+1})">Cancel</button>
        <button class="cv-btn primary" onclick="saveTaskEdit('${taskId}',${windowIdCounter+1})">Save</button>
      </div>
    </div>`;
    createWindow('commit', `Edit: ${t.title.substring(0,30)}`, html, {width:450,height:420});
  }catch(e){ console.warn('editTask:', e); }
}

async function saveTaskEdit(taskId, winId){
  const fields = {
    title: document.getElementById(`editTitle-${taskId}`)?.value.trim(),
    description: document.getElementById(`editDesc-${taskId}`)?.value.trim(),
    agent: document.getElementById(`editAgent-${taskId}`)?.value||null,
    priority: parseInt(document.getElementById(`editPriority-${taskId}`)?.value||'0'),
    autopilot: document.getElementById(`editAP-${taskId}`)?.checked||false,
  };
  try{
    await fetch(`${API}/tasks/${taskId}`,{method:'PATCH',headers:{'Content-Type':'application/json'},body:JSON.stringify(fields)});
    addActivity('📋',`Task updated: ${fields.title}`);
    closeWindow(winId);
    loadBoard();
  }catch(e){ alert('Failed to save: '+e.message); }
}

// ═══ PUSH & PR ═════════════════════════════════════════════════════════════
async function pushAndPR(){
  if(!focusedId||!runnerOnline) return;
  const ds = devStates[focusedId];
  if(!ds||ds.status!=='online'){ alert('Project not available on runner'); return; }

  const branch = ds.branch||'';
  if(branch==='main'||branch==='master'){
    alert('⛔ Cannot push directly to '+branch+'. Create a feature branch first.');
    return;
  }

  if(ds.dirtyCount>0){
    const choice=confirm('You have '+ds.dirtyCount+' uncommitted change(s).\n\nClick OK to push anyway (uncommitted changes will NOT be included), or Cancel to go back and commit first.');
    if(!choice) return;
  }

  const title = prompt('PR Title:', branch.replace(/[-_]/g,' '));
  if(!title) return;
  const body = prompt('PR Description (optional):', '')||'';
  const base = prompt('Base branch:', 'main')||'main';

  const btn = document.getElementById('btnPushPR');
  btn.classList.add('running'); btn.disabled=true;
  addActivity('🚀','Pushing '+branch+' and creating PR...');

  try{
    const r = await fetch(`${API}/runner/git/push-pr`,{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({projectId:focusedId, branch, base, title, body, remote:'origin'})
    });
    if(!r.ok){
      const e=await r.json();
      throw new Error(e.detail||r.statusText);
    }
    const result=await r.json();
    const prUrl=result.prUrl||result.pr_url||'';
    let html='<div class="pr-result">';
    html+='<div style="color:var(--green);font-size:14px;font-weight:700;margin-bottom:8px">✅ Push & PR Complete</div>';
    if(prUrl) html+='<div>PR URL: <a href="'+esc(prUrl)+'" target="_blank">'+esc(prUrl)+'</a></div>';
    html+='<div>Branch: <span class="pr-url">'+esc(branch)+' → '+esc(base)+'</span></div>';
    if(result.stdout) html+='<div style="margin-top:8px;font-family:var(--font-mono);font-size:10px;color:var(--muted);white-space:pre-wrap">'+esc(result.stdout)+'</div>';
    html+='</div>';
    createWindow('commit','🚀 PR Created', html, {width:500, height:300});
    addActivity('✅','PR created: '+title);
  }catch(e){
    addActivity('❌','Push & PR failed: '+e.message);
    alert('Push & PR failed: '+e.message);
  }finally{
    btn.classList.remove('running'); btn.disabled=!runnerOnline||!focusedId;
  }
}

async function confirmCommitAndPR(){
  const titleEl=document.getElementById('commitTitle');
  const descEl=document.getElementById('commitDesc');
  if(!titleEl||!descEl)return;
  const title=titleEl.value.trim();
  const desc=descEl.value.trim();
  if(!title){ alert('Commit title is required'); return; }

  const ds = devStates[focusedId];
  const branch = ds?.branch||'';
  if(branch==='main'||branch==='master'){
    alert('⛔ Cannot push to '+branch+'. Create a feature branch first.');
    return;
  }

  const confirmBtn=document.querySelector('.cv-actions .cv-btn.primary:last-child');
  if(confirmBtn){ confirmBtn.disabled=true; confirmBtn.textContent='Working...'; }

  const message=desc?`${title}\n\n${desc}`:title;
  try{
    const safe=message.replace(/"/g,'\\"').replace(/`/g,'\\`');
    await runRunnerCmd(focusedId,`git commit -m "${safe}"`,30);
    addActivity('✅',`Committed: ${title}`);
    closeAllCommitWindows();
    await refreshFocused();

    const base=prompt('Base branch for PR:','main')||'main';
    const prBody=prompt('PR Description (optional):','')||'';
    addActivity('🚀','Pushing and creating PR...');
    const r=await fetch(`${API}/runner/git/push-pr`,{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({projectId:focusedId, branch, base, title, body:prBody, remote:'origin'})
    });
    if(!r.ok){ const e=await r.json(); throw new Error(e.detail||r.statusText); }
    const result=await r.json();
    const prUrl2=result.prUrl||result.pr_url||'';
    let html='<div class="pr-result"><div style="color:var(--green);font-size:14px;font-weight:700;margin-bottom:8px">✅ Committed & PR Created</div>';
    if(prUrl2) html+='<div>PR: <a href="'+esc(prUrl2)+'" target="_blank">'+esc(prUrl2)+'</a></div>';
    html+='</div>';
    createWindow('commit','🚀 PR Created',html,{width:500,height:250});
    addActivity('✅','PR created: '+title);
  }catch(e){
    addActivity('❌','Commit & PR failed: '+e.message);
    alert('Failed: '+e.message);
  }
}

// ═══ USAGE / BUDGET ══════════════════════════════════════════════════════
function toggleUsage(){
  usageOpen=!usageOpen;
  const overlay=document.getElementById('usageOverlay');
  if(usageOpen){ overlay.classList.add('open'); loadUsageData(); }
  else{
    overlay.classList.remove('open');
    if(_usageAutoRefreshTimer){ clearTimeout(_usageAutoRefreshTimer); _usageAutoRefreshTimer=null; }
  }
}

// ─── INCIDENTS & HISTORY ─────────────────────────────────────────────────────
function closeIncidents(){
  document.getElementById('incidentsOverlay').classList.remove('open');
}

async function showIncidents(projectId){
  const overlay=document.getElementById('incidentsOverlay');
  const body=document.getElementById('incidentsBody');
  overlay.classList.add('open');
  body.innerHTML='<div style="color:var(--muted);text-align:center;padding:20px">Loading...</div>';
  try{
    const [incR, projR] = await Promise.all([
      fetch(`${API}/health/incidents?project_id=${encodeURIComponent(projectId)}&limit=20`).then(r=>r.json()).catch(()=>null),
      fetch(`${API}/projects/${encodeURIComponent(projectId)}`).then(r=>r.json()).catch(()=>null),
    ]);
    let html='';
    const proj=projR;
    const projName=proj?.name||projectId;
    html+=`<div class="usage-card-title" style="font-size:11px;font-weight:700;color:var(--accent);margin-bottom:8px">${esc(projName)}</div>`;

    // Check history section (uptime bars per check)
    if(proj?.checks?.length){
      html+='<div class="usage-card"><div class="usage-card-title">Check History (24h uptime)</div>';
      for(const chk of proj.checks){
        const uptime=chk.uptime_24h??100;
        const cls=uptime>=95?'ok':uptime>=70?'warn':'crit';
        html+=`<div style="margin-bottom:8px">
          <div class="usage-stat"><span>${esc(chk.check_id||chk.id||'check')}</span><span class="val">${uptime.toFixed(1)}%</span></div>
          <div class="usage-bar-wrap"><div class="usage-bar ${cls}" style="width:${Math.min(100,uptime)}%"></div></div>
          <div class="usage-stat" style="margin-top:2px"><span>Status</span><span class="val" style="color:${chk.status==='up'?'var(--green)':chk.status==='down'?'var(--red)':'var(--yellow)'}">${esc(chk.status||'—')}</span></div>
        </div>`;
      }
      html+='</div>';
    }

    // Open incidents
    const open=(incR?.open||[]);
    const all=(incR?.incidents||[]);
    if(open.length){
      html+='<div class="usage-card" style="border-color:var(--red)"><div class="usage-card-title" style="color:var(--red)">&#9888; Open Incidents ('+open.length+')</div>';
      for(const inc of open.slice(0,5)){
        html+=`<div style="font-size:11px;padding:4px 0;border-bottom:1px solid var(--border)">
          <strong>${esc(inc.check_id)}</strong> — ${esc(inc.message||'No message')}
          <span style="color:var(--muted);float:right">${timeAgo(inc.started_at)}</span>
        </div>`;
      }
      html+='</div>';
    }

    // Recent resolved
    const resolved=all.filter(i=>i.resolved_at).slice(0,8);
    if(resolved.length){
      html+='<div class="usage-card"><div class="usage-card-title">Recent Resolved</div>';
      for(const inc of resolved){
        const durMs=inc.resolved_at&&inc.started_at?(new Date(inc.resolved_at)-new Date(inc.started_at)):null;
        const dur=durMs?Math.round(durMs/60000)+'m':'—';
        html+=`<div style="font-size:11px;padding:4px 0;border-bottom:1px solid var(--border)">
          <span style="color:var(--green)">✓</span> ${esc(inc.check_id)} — ${esc(inc.message||'Resolved')}
          <span style="color:var(--muted);float:right">${timeAgo(inc.resolved_at)} (${dur})</span>
        </div>`;
      }
      html+='</div>';
    }

    if(!html.includes('usage-card')){ html+='<div style="color:var(--muted);text-align:center;padding:20px">No incidents found</div>'; }
    body.innerHTML=html;
  }catch(e){
    body.innerHTML=`<div style="color:var(--red);text-align:center;padding:20px">Error: ${esc(e.message)}</div>`;
  }
}

// Chart instances (destroyed before re-render to avoid canvas reuse errors)
let _usageDailyChart=null, _usageModelChart=null;
let _usageAutoRefreshTimer=null;

async function loadUsageData(){
  const body=document.getElementById('usageBody');
  body.innerHTML='<div style="color:var(--muted);text-align:center;padding:20px">Loading usage data...</div>';

  try{
    const [chartR, limitsR] = await Promise.all([
      fetch(`${API}/usage/chart-data`).then(r=>r.json()).catch(()=>null),
      fetch(`${API}/usage/limits`).then(r=>r.json()).catch(()=>null),
    ]);

    let html='';

    // Refresh bar
    const now=new Date().toLocaleTimeString();
    html+=`<div class="usage-refresh-bar">
      <span class="usage-auto-tag">Last refreshed: ${now}</span>
      <button class="usage-refresh-btn" onclick="loadUsageData()">&#8635; Refresh</button>
    </div>`;

    // Rate limit cards
    if(limitsR){
      const session = limitsR.session_5h || {};
      const weekly = limitsR.weekly_7d || {};
      html+=renderUsageLimitCard('Session (5h window)', session);
      html+=renderUsageLimitCard('Weekly (7d window)', weekly);
    }

    // Totals strip
    if(chartR && chartR.totals){
      const t=chartR.totals;
      html+='<div class="usage-card"><div class="usage-card-title">Totals</div>';
      html+='<div class="usage-stat"><span>Sessions</span><span class="val">'+fmt(t.total_sessions||0)+'</span></div>';
      html+='<div class="usage-stat"><span>Total Tokens</span><span class="val">'+fmt(t.total_tokens||0)+'</span></div>';
      html+='<div class="usage-stat"><span>Input</span><span class="val">'+fmt(t.total_input_tokens||0)+'</span></div>';
      html+='<div class="usage-stat"><span>Output</span><span class="val">'+fmt(t.total_output_tokens||0)+'</span></div>';
      html+='</div>';
    }

    // Charts (canvases — data injected after innerHTML set)
    const hasDaily = chartR && chartR.daily_labels && chartR.daily_labels.length;
    const hasModels = chartR && chartR.model_labels && chartR.model_labels.length;
    if(hasDaily || hasModels){
      html+='<div class="usage-charts">';
      if(hasDaily){
        html+=`<div class="usage-chart-box">
          <div class="usage-chart-label">Daily Tokens (14d)</div>
          <canvas id="usageDailyCanvas" height="140"></canvas>
        </div>`;
      }
      if(hasModels){
        html+=`<div class="usage-chart-box">
          <div class="usage-chart-label">By Model</div>
          <canvas id="usageModelCanvas" height="140"></canvas>
        </div>`;
      }
      html+='</div>';
    }

    // Insights
    if(chartR && chartR.insights && chartR.insights.length){
      const insights=chartR.insights;
      html+='<div class="usage-card"><div class="usage-card-title">Insights ('+insights.length+')</div>';
      for(const ins of insights){
        const msg=typeof ins==='string'?ins:(ins.message||ins.description||JSON.stringify(ins));
        html+=`<div style="font-size:11px;color:var(--text);padding:5px 0;border-bottom:1px solid var(--border)">&#128161; ${esc(msg)}</div>`;
      }
      html+='</div>';
    }

    body.innerHTML=html||'<div class="mem-empty">No usage data available</div>';

    // Destroy previous chart instances before creating new ones
    if(_usageDailyChart){ _usageDailyChart.destroy(); _usageDailyChart=null; }
    if(_usageModelChart){ _usageModelChart.destroy(); _usageModelChart=null; }

    // Render daily bar chart
    if(hasDaily){
      const ctx=document.getElementById('usageDailyCanvas');
      if(ctx && typeof Chart!=='undefined'){
        _usageDailyChart=new Chart(ctx,{
          type:'bar',
          data:{
            labels:chartR.daily_labels,
            datasets:[
              {label:'Input',data:chartR.daily_input,backgroundColor:'rgba(124,166,196,0.6)',borderColor:'rgba(124,166,196,1)',borderWidth:1},
              {label:'Output',data:chartR.daily_output,backgroundColor:'rgba(80,181,131,0.6)',borderColor:'rgba(80,181,131,1)',borderWidth:1},
            ]
          },
          options:{
            responsive:true,maintainAspectRatio:false,
            plugins:{legend:{labels:{color:'#8a8878',font:{size:9}}}},
            scales:{
              x:{ticks:{color:'#8a8878',font:{size:8},maxRotation:45},grid:{color:'#3a3a3a'}},
              y:{ticks:{color:'#8a8878',font:{size:9},callback:v=>v>=1e6?(v/1e6).toFixed(1)+'M':v>=1e3?(v/1e3).toFixed(0)+'K':v},grid:{color:'#3a3a3a'}},
            }
          }
        });
      }
    }

    // Render model donut chart
    if(hasModels){
      const ctx=document.getElementById('usageModelCanvas');
      if(ctx && typeof Chart!=='undefined'){
        const palette=['#7ca6c4','#50b583','#eab308','#f97316','#8b7ec6','#d97aa0'];
        _usageModelChart=new Chart(ctx,{
          type:'doughnut',
          data:{
            labels:chartR.model_labels,
            datasets:[{data:chartR.model_tokens,backgroundColor:palette.slice(0,chartR.model_labels.length),borderWidth:0}]
          },
          options:{
            responsive:true,maintainAspectRatio:false,
            plugins:{legend:{position:'bottom',labels:{color:'#8a8878',font:{size:9},padding:8,boxWidth:10}}}
          }
        });
      }
    }

    // Auto-refresh every 30s
    if(_usageAutoRefreshTimer) clearTimeout(_usageAutoRefreshTimer);
    _usageAutoRefreshTimer=setTimeout(()=>{ if(usageOpen) loadUsageData(); },30000);

  }catch(e){
    body.innerHTML='<div style="color:var(--red);text-align:center;padding:20px">Failed to load usage data: '+esc(e.message)+'</div>';
  }
}

function renderUsageLimitCard(label, data){
  const pct = data.percent_used!=null ? Math.min(100,Math.round(data.percent_used)) : 0;
  const cls = pct>=90?'crit':pct>=70?'warn':'ok';
  const statusLabel = cls==='crit'?'CRITICAL':cls==='warn'?'WARNING':'OK';
  const statusColor = cls==='crit'?'var(--red)':cls==='warn'?'var(--yellow)':'var(--green)';
  const tokens = fmt(data.tokens_used||0);
  const cap = fmt(data.estimated_cap||0);
  const reset = data.resets_in||'—';
  let html=`<div class="usage-card" style="border-color:${pct>=90?'var(--red)':pct>=70?'var(--yellow)':'var(--border)'}">
    <div class="usage-card-title" style="display:flex;justify-content:space-between;align-items:center">${esc(label)}<span style="color:${statusColor};font-size:9px;font-weight:800;letter-spacing:.5px">${statusLabel}</span></div>
    <div class="usage-stat"><span>${pct}% used</span><span class="val">${tokens} / ${cap}</span></div>
    <div class="usage-bar-wrap"><div class="usage-bar ${cls}" style="width:${pct}%"></div></div>
    <div class="usage-stat"><span>Resets in</span><span class="val">${esc(String(reset))}</span></div>
  </div>`;
  return html;
}

// ═══ ORCHESTRATOR ═══════════════════════════════════════════════════════
let orchAbort = null;

function toggleOrchestrator(){
  orchOpen=!orchOpen;
  const overlay=document.getElementById('orchOverlay');
  if(orchOpen){ overlay.classList.add('open'); }
  else{ overlay.classList.remove('open'); if(orchAbort){orchAbort.abort();orchAbort=null;} }
}

async function runMission(){
  const input=document.getElementById('orchInput');
  const task=input.value.trim();
  if(!task){ alert('Enter a mission description'); return; }

  const btn=document.getElementById('orchRunBtn');
  const status=document.getElementById('orchStatus');
  const body=document.getElementById('orchBody');
  btn.disabled=true;
  btn.textContent='⏳ Running...';
  status.textContent='Starting orchestrator...';
  body.innerHTML='';

  orchAbort=new AbortController();
  addActivity('⚡','Mission started: '+task.substring(0,60));

  try{
    const response = await fetch(`${API}/orchestrator/stream`,{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({task, use_memory:true}),
      signal:orchAbort.signal
    });

    if(!response.ok){
      const e=await response.json();
      throw new Error(e.detail||response.statusText);
    }

    const reader=response.body.getReader();
    const decoder=new TextDecoder();
    let buffer='';

    while(true){
      const {done,value}=await reader.read();
      if(done) break;
      buffer+=decoder.decode(value,{stream:true});
      const lines=buffer.split('\n');
      buffer=lines.pop()||'';

      let eventType='';
      for(const line of lines){
        if(line.startsWith('event: ')){
          eventType=line.substring(7).trim();
        } else if(line.startsWith('data: ')){
          try{
            const parsed=JSON.parse(line.substring(6));
            if(eventType==='phase'){
              const phaseClass=parsed.phase||'';
              status.textContent='Phase: '+parsed.phase;
              body.innerHTML+=`<div class="orch-phase">
                <div class="orch-phase-title ${escAttr(phaseClass)}">${getPhaseIcon(parsed.phase)} ${esc(parsed.phase)}</div>
                <div class="orch-phase-detail">${esc(parsed.detail||'')}</div>
              </div>`;
              body.scrollTop=body.scrollHeight;
              // Athena: reflect current phase in scene status text
              if(ATHENA_SCENE && athenaScene) athenaScene.setStatus((parsed.phase||'').toUpperCase());
            } else if(eventType==='subtask'){
              status.textContent='Subtask: '+parsed.agent+' - '+(parsed.status||'');
              body.innerHTML+=`<div class="orch-subtask">
                <div class="orch-subtask-header">
                  <span class="agent-tag">${esc(parsed.agent||'?')}</span>
                  <span>${esc(parsed.task||'')}</span>
                  <span class="status-tag ${escAttr(parsed.status||'')}">${esc(parsed.status||'')}</span>
                </div>
                ${parsed.result?'<div class="orch-subtask-result">'+esc(parsed.result)+'</div>':''}
              </div>`;
              body.scrollTop=body.scrollHeight;
              // Athena: animate the active agent sprite
              if(ATHENA_SCENE && athenaScene){
                const agentState = parsed.status==='running' ? 'executing' : parsed.status==='error' ? 'error' : 'reviewing';
                athenaScene.resetAllAgents('idle');
                athenaScene.setAgentState(parsed.agent||'manager', agentState);
                athenaScene.setStatus((parsed.agent||'?').toUpperCase());
              }
            } else if(eventType==='done'){
              status.textContent='Mission complete!';
              body.innerHTML+=`<div class="orch-final">
                <div class="orch-final-title">✅ Final Output</div>
                <div class="orch-final-text">${esc(parsed.final_output||'(no output)')}</div>
              </div>`;
              body.scrollTop=body.scrollHeight;
              addActivity('✅','Mission complete');
              // Athena: return all agents to idle
              if(ATHENA_SCENE && athenaScene){ athenaScene.resetAllAgents('idle'); athenaScene.setStatus('DONE'); }
            } else if(eventType==='error'){
              status.textContent='Error';
              body.innerHTML+=`<div class="orch-phase"><div class="orch-phase-title error">❌ Error</div><div class="orch-phase-detail">${esc(parsed.detail||'Unknown error')}</div></div>`;
              addActivity('❌','Mission error: '+(parsed.detail||''));
              // Athena: error state on all sprites
              if(ATHENA_SCENE && athenaScene){ athenaScene.resetAllAgents('error'); athenaScene.setStatus('ERROR'); }
            }
          }catch(e){}
        }
      }
    }
  }catch(e){
    if(e.name==='AbortError'){
      status.textContent='Cancelled';
      addActivity('🛑','Mission cancelled');
    }else{
      status.textContent='Error: '+e.message;
      body.innerHTML+=`<div class="orch-phase"><div class="orch-phase-title error">❌ Error</div><div class="orch-phase-detail">${esc(e.message)}</div></div>`;
      addActivity('❌','Mission error: '+e.message);
    }
  }finally{
    btn.disabled=false;
    btn.textContent='▶ Run Mission';
    orchAbort=null;
  }
}

function getPhaseIcon(phase){
  const icons={starting:'🔄',planning:'📋',planned:'📋',executing:'⚡',reviewing:'🔍',synthesizing:'🔧',done:'✅'};
  return icons[phase]||'▶';
}

// ═══ MEMORY ═════════════════════════════════════════════════════════════
function toggleMemory(){
  memOpen=!memOpen;
  const overlay=document.getElementById('memOverlay');
  if(memOpen){
    overlay.classList.add('open');
    if(!agentList.length) loadAgentList();
    else loadMemories();
  }else{
    overlay.classList.remove('open');
  }
}

async function loadAgentList(){
  try{
    const r=await fetch(`${API}/agents`);
    const data=await r.json();
    agentList=(data.agents||[]).map(a=>a.id);
  }catch(e){ agentList=['manager','frontend','backend','tester']; }

  const memSel=document.getElementById('memAgentSelect');
  const chatSel=document.getElementById('agentSelect');
  if(memSel){
    memSel.innerHTML=agentList.map((a,i)=>`<option value="${escAttr(a)}" ${i===0?'selected':''}>${esc(a)}</option>`).join('');
  }
  if(chatSel){
    const current=chatSel.value;
    chatSel.innerHTML=agentList.map(a=>`<option value="${escAttr(a)}" ${a===current?'selected':''}>${esc(a)}</option>`).join('');
  }
  loadMemories();
}

async function loadMemories(){
  const agentId=document.getElementById('memAgentSelect')?.value;
  const body=document.getElementById('memBody');
  if(!agentId){ body.innerHTML='<div class="mem-empty">Select an agent</div>'; return; }
  body.innerHTML='<div class="mem-empty">Loading...</div>';

  try{
    const r=await fetch(`${API}/memory/${agentId}`);
    const data=await r.json();
    const memories=data.memories||[];
    const stats=data.stats||{};

    if(!memories.length){
      body.innerHTML='<div class="mem-empty">No memories for '+esc(agentId)+'</div>';
      if(stats.count!=null) body.innerHTML+='<div class="mem-stats">Total: '+stats.count+'</div>';
      return;
    }

    let html='';
    if(stats.count!=null) html+='<div class="mem-stats">Total: '+stats.count+' memories</div>';
    for(const m of memories){
      const content=typeof m==='string'?m:(m.memory||m.content||JSON.stringify(m));
      const meta=m.created_at?'<div class="mem-meta"><span>'+timeAgo(m.created_at)+'</span></div>':'';
      html+=`<div class="mem-item">${esc(content)}${meta}</div>`;
    }
    body.innerHTML=html;
  }catch(e){
    body.innerHTML='<div class="mem-empty" style="color:var(--red)">Error: '+esc(e.message)+'</div>';
  }
}

async function searchMemories(){
  const agentId=document.getElementById('memAgentSelect')?.value;
  const query=document.getElementById('memSearchInput')?.value.trim();
  const body=document.getElementById('memBody');
  if(!agentId||!query){ if(!query)loadMemories(); return; }
  body.innerHTML='<div class="mem-empty">Searching...</div>';

  try{
    const r=await fetch(`${API}/memory/search`,{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({agent_id:agentId, query, limit:20})
    });
    const data=await r.json();
    const results=data.results||[];
    if(!results.length){ body.innerHTML='<div class="mem-empty">No results for "'+esc(query)+'"</div>'; return; }

    let html='<div class="mem-stats">Search: '+results.length+' result(s)</div>';
    for(const m of results){
      const content=typeof m==='string'?m:(m.memory||m.content||JSON.stringify(m));
      const score=m.score!=null?'<span>score: '+(m.score).toFixed(2)+'</span>':'';
      html+=`<div class="mem-item">${esc(content)}<div class="mem-meta">${score}</div></div>`;
    }
    body.innerHTML=html;
  }catch(e){
    body.innerHTML='<div class="mem-empty" style="color:var(--red)">Search failed: '+esc(e.message)+'</div>';
  }
}

async function addMemory(){
  const agentId=document.getElementById('memAgentSelect')?.value;
  const input=document.getElementById('memAddInput');
  const content=input?.value.trim();
  if(!agentId||!content) return;
  input.value='';

  try{
    await fetch(`${API}/memory/add`,{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({agent_id:agentId, content})
    });
    addActivity('🧠','Memory added for '+agentId);
    loadMemories();
  }catch(e){
    alert('Failed to add memory: '+e.message);
  }
}

async function clearMemories(){
  const agentId=document.getElementById('memAgentSelect')?.value;
  if(!agentId) return;
  if(!confirm('Clear ALL memories for '+agentId+'? This cannot be undone.')) return;

  try{
    await fetch(`${API}/memory/${agentId}`,{method:'DELETE'});
    addActivity('🗑️','Memories cleared for '+agentId);
    loadMemories();
  }catch(e){
    alert('Failed to clear memories: '+e.message);
  }
}

// ═══ ESCAPE KEY HANDLER ═══════════════════════════════════════════════════
document.addEventListener('keydown',e=>{
  if(e.key==='Escape'){
    if(boardOpen) toggleTaskBoard();
    else if(usageOpen) toggleUsage();
    else if(orchOpen) toggleOrchestrator();
    else if(memOpen) toggleMemory();
    else if(document.getElementById('incidentsOverlay')?.classList.contains('open')) closeIncidents();
  }
});

// ═══ REFRESH ═══════════════════════════════════════════════════════════════
async function refreshAll(){
  addActivity('🔄','Refreshing all data...');
  await Promise.all([loadProjects(),pollRunner(),pollApiStatus()]);
  if(runnerOnline) await fetchAllDevStates();
  if(focusedId) await refreshFocused();
  addActivity('✅','Refresh complete');
}

// ═══ INIT ════════════════════════════════════════════════════════════════
async function init(){
  // Restore mode from URL or localStorage
  const path = window.location.pathname;
  if(path === '/workshop'){
    currentMode = 'workshop';
  } else if(path === '/'){
    const saved = localStorage.getItem('athenaMode');
    if(saved === 'workshop') currentMode = 'workshop';
  }
  applyMode();

  // Handle entry transitions from old page-based navigation
  const transition = sessionStorage.getItem('pageTransition');
  if(transition){
    sessionStorage.removeItem('pageTransition');
    if(transition === 'toWorkshop') currentMode = 'workshop';
    else if(transition === 'toBridge') currentMode = 'bridge';
    applyMode();
    document.body.classList.add('page-enter-active');
    requestAnimationFrame(() => {
      requestAnimationFrame(() => {
        document.body.classList.remove('page-enter-active');
        document.body.classList.add('page-enter-ready');
        setTimeout(() => document.body.classList.remove('page-enter-ready'), 500);
      });
    });
  }

  fetchBuildSha();
  await pollApiStatus();
  await pollRunner();
  await loadProjects();
  await loadAgentList();
  if(runnerOnline) await fetchAllDevStates();
  connectHealthSSE();

  setInterval(pollApiStatus, 15000);
  setInterval(pollRunner, 10000);
  setInterval(()=>{ if(runnerOnline) fetchAllDevStates(); }, 30000);
  setInterval(loadProjects, 60000);
  addActivity('🚀','Athena initialized');
}
init();
</script>
</body>
</html>
